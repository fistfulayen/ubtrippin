# PRD 016 Phase 1 â€” Flight Status (FlightAware AeroAPI)

You are building live flight status for UBTRIPPIN, a Next.js 16 app with Supabase, pnpm, and App Router.

**CRITICAL: Read `scripts/prompts/016-flightaware-reference.md` in this repo FIRST. It contains verified current FlightAware AeroAPI patterns. Use these patterns exactly. Do NOT use patterns from your training data.**

**SECURITY RULE: Do NOT use createSecretClient() or service role to bypass RLS. Fix RLS policies instead. This code will be security-audited monthly.**

## Environment Variables
- `FLIGHTAWARE_API_KEY` â€” FlightAware AeroAPI key

## 1. Database Migration (`supabase/migrations/20260228000002_trip_item_status.sql`)

```sql
CREATE TABLE IF NOT EXISTS trip_item_status (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  item_id uuid NOT NULL REFERENCES trip_items(id) ON DELETE CASCADE,
  status text NOT NULL DEFAULT 'unknown'
    CHECK (status IN ('on_time', 'delayed', 'cancelled', 'diverted', 'en_route', 'boarding', 'landed', 'arrived', 'unknown')),
  delay_minutes integer,
  gate text,
  terminal text,
  platform text,
  estimated_departure timestamptz,
  estimated_arrival timestamptz,
  actual_departure timestamptz,
  actual_arrival timestamptz,
  raw_response jsonb,
  source text NOT NULL DEFAULT 'flightaware',
  last_checked_at timestamptz DEFAULT now(),
  status_changed_at timestamptz,
  previous_status text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  UNIQUE(item_id)
);

CREATE INDEX idx_trip_item_status_item ON trip_item_status(item_id);
CREATE INDEX idx_trip_item_status_checked ON trip_item_status(last_checked_at);

ALTER TABLE trip_item_status ENABLE ROW LEVEL SECURITY;

-- Users can see status for their own trips
CREATE POLICY "status_select_owner" ON trip_item_status
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM trip_items ti
      JOIN trips t ON ti.trip_id = t.id
      WHERE ti.id = trip_item_status.item_id
        AND t.user_id = auth.uid()
    )
  );

-- Also allow collaborators and family members to see status
-- Use existing is_trip_owner() if available, otherwise:
CREATE POLICY "status_select_collaborator" ON trip_item_status
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM trip_items ti
      JOIN trip_collaborators tc ON ti.trip_id = tc.trip_id
      WHERE ti.id = trip_item_status.item_id
        AND tc.user_id = auth.uid()
    )
  );
```

## 2. FlightAware Client (`src/lib/flight-status.ts`)

Fetch flight status from FlightAware AeroAPI. See the reference doc for exact API patterns.

```typescript
interface FlightStatusResult {
  status: 'on_time' | 'delayed' | 'cancelled' | 'diverted' | 'en_route' | 'boarding' | 'landed' | 'arrived' | 'unknown'
  delayMinutes: number | null
  gate: string | null
  terminal: string | null
  estimatedDeparture: string | null  // ISO 8601
  estimatedArrival: string | null
  actualDeparture: string | null
  actualArrival: string | null
  raw: Record<string, unknown>
}
```

- Extract IATA flight code from trip item (e.g., `details_json.flight_number` like "AF1234")
- Extract departure date from `start_date`
- Call `GET /flights/{ident}?start={date}T00:00:00Z&end={date}T23:59:59Z`
- Map FlightAware status to our status enum (see reference doc)
- Calculate delay from `estimated_off` vs `scheduled_off` (or `delay_departure` field)

## 3. Status Check Scheduler (`src/app/api/internal/status-check/route.ts`)

Internal endpoint called by cron every 15 minutes. No user auth (internal only).

1. Query `trip_items` where `kind = 'flight'` AND `start_date` within 48 hours of now
2. For each eligible item, check if `last_checked_at` is stale based on schedule:
   - 48-24h before departure: check every 8 hours
   - 24-4h before departure: check every 2 hours
   - 4-0h before departure: check every 30 minutes
   - After departure until arrival: check every 15 minutes
   - After arrival: one final check, then stop
3. Fetch status from FlightAware for stale items
4. Upsert into `trip_item_status`
5. If status changed from previous, set `status_changed_at` and `previous_status`
6. If status changed AND user has webhooks configured, emit `item.status_changed` event (use existing webhook infrastructure from PRD 013)

Use `createSecretClient()` here â€” this is a cron job with no user context (legitimate use).

## 4. API Endpoints

### `GET /api/v1/trips/:id/status` (`src/app/api/v1/trips/[id]/status/route.ts`)
- Auth required (cookie-based)
- Returns all item statuses for the trip
- Join `trip_items` â†’ `trip_item_status`
- Only return statuses for flight items (trains come in Phase 2)

### `GET /api/v1/items/:id/status` (`src/app/api/v1/items/[id]/status/route.ts`)
- Auth required
- Returns single item status with full detail

### `POST /api/v1/items/:id/status/refresh` (`src/app/api/v1/items/[id]/status/refresh/route.ts`)
- Auth required
- Force a fresh status check right now
- Rate limit: free users get 3/day, Pro users unlimited
- Check `subscription_tier` on `profiles` (NOT `tier`)
- Calls FlightAware, upserts status, returns result

## 5. Trip Detail Page â€” Status Badges (`src/components/trips/item-status-badge.tsx`)

A client component that shows live status on trip item cards:

```
ðŸŸ¢ On time Â· Gate 2F Â· Terminal 1       [â†»]
   Last checked 3 min ago
```

```
ðŸŸ¡ Delayed 15 min Â· New departure 13:01  [â†»]
   Gate 2F Â· Last checked 1 min ago
```

```
ðŸ”´ Cancelled                              [â†»]
   Last checked just now
```

- Color coding: green (on_time/arrived), amber (delayed), red (cancelled/diverted), blue (en_route/boarding), gray (unknown)
- Show gate, terminal when available
- "Last checked X min ago" timestamp
- Refresh button calls `POST /api/v1/items/:id/status/refresh`
- Auto-refresh: poll `GET /api/v1/items/:id/status` every 2 minutes when page is visible (use `useEffect` + `setInterval` + `document.visibilityState`)

### Trip Card Summary Badge (`src/components/trips/trip-status-summary.tsx`)

On the trips list page, for trips with items departing within 48h:
- "All on time" (green pill)
- "1 delay" (amber pill)  
- "1 cancelled" (red pill)

Fetch from `GET /api/v1/trips/:id/status` and summarize.

## 6. Status History Display

When an item's `previous_status` is set, show it:
```
ðŸŸ¢ On time (was delayed 20 min)
```

## Important Patterns

- Use `createClient()` from `src/lib/supabase/server.ts` for authenticated API routes
- Use `createSecretClient()` ONLY for the cron status checker (no user context)
- Check `subscription_tier` on `profiles` (NOT `tier`) for rate limiting
- Existing webhook infrastructure: `webhook_delivery_queue` table + edge function (PRD 013)
- For the `item.status_changed` webhook event, follow the same pattern as existing events
- pnpm package manager
- Run `npx tsc --noEmit` before committing

## Do NOT

- Build train status (that's Phase 2)
- Build MCP/CLI tools (that's Phase 3)
- Bypass RLS with service client on user-facing routes
- Store the FlightAware API key in client-side code
- Call FlightAware from the browser â€” all calls go through our API
