# PRD 022 Phase 4 — Code Quality Sweep

## What to Do

### 1. ESLint Setup
- Install: `pnpm add -D eslint @eslint/js typescript-eslint`
- Create `eslint.config.mjs` (flat config) with:
  - `@typescript-eslint/recommended`
  - Rules: no-unused-vars (warn), no-explicit-any (error), no-console (warn for src/, off for scripts/)
- Add to package.json: `"lint": "eslint src/"` 
- Fix all errors (not warnings — those can stay for now)

### 2. Fix `as any` casts
Find all `as any` in src/ and replace with proper types. Currently 3 remaining.

### 3. Consistent Error Response Format
All API v1 routes should return errors as:
```json
{ "error": { "code": "string", "message": "string" } }
```
Audit all 72 routes. Fix any that use a different format (e.g., plain `{ error: "string" }` or `{ message: "string" }`).

### 4. Input Validation
All POST/PATCH routes must validate request body before processing. Check for:
- Missing required fields → 400 with descriptive message
- Invalid field types → 400
- No raw `request.json()` without validation

### 5. CI Integration
Add ESLint check to the security workflow:
```yaml
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint
```

## Quality
- `npx tsc --noEmit` must pass
- `pnpm lint` must pass with 0 errors
- `pnpm test` must still pass (88 tests)
- Do NOT change any test behavior
- Do NOT use createSecretClient() in user-facing routes. This code will be security-audited monthly.

## Commit
```
git add -A && git commit -m "feat(022-p4): code quality — ESLint, type safety, consistent errors, input validation"
git push origin feat/022-p4
```
