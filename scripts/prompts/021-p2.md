# PRD 021 Phase 2 — Context-Aware Pro Upsell Triggers

## Context
Phase 1 is complete: `UpgradeCard` component (inline/card/banner variants), global upgrade banner for free users, early adopter counter showing spots remaining. PR #8 merged.

## What to Build

### 1. Context-Aware Upsell Triggers
Free users should see upgrade prompts at natural friction points, not random banners:

- **Trip limit hit** (3 active trips): When user tries to create trip #4, show upgrade card explaining Pro removes the limit
- **Extraction limit hit** (10/month): When email extraction fails due to limit, show upgrade card
- **Loyalty vault limit** (3 programs): When adding program #4, show upgrade card
- **Guide export** (PDF export is Pro): When free user clicks Export PDF, show upgrade card instead
- **Webhook registration**: When free user tries to add webhook, show upgrade card
- **Calendar feed**: When free user tries to enable calendar, show upgrade card

### 2. Smart Banner Dismissal
- Current global banner shows on every page load for free users — too aggressive
- Add `dismissed_upgrade_banner_at` to profiles or localStorage
- After dismissal, don't show again for 7 days
- After 3 dismissals, stop showing the global banner entirely (still show contextual ones)

### 3. Upgrade Success Celebration
- After Stripe checkout success redirect, show confetti + welcome message
- "Welcome to Pro! Here's what you just unlocked:" with feature list
- One-time display (track in localStorage)

## Existing Components
- `src/components/billing/upgrade-card.tsx` — reusable, has inline/card/banner variants
- `src/components/billing/upgrade-banner.tsx` — global banner
- `src/components/billing/early-adopter-counter.tsx` — spots remaining
- `src/lib/billing.ts` — billing helpers
- `src/lib/stripe.ts` — Stripe client

## Tech Stack
- Next.js 16 App Router, TypeScript, Tailwind CSS, pnpm
- Supabase with RLS — use `createClient()` from `src/lib/supabase/server.ts`
- Do NOT use `createSecretClient()` or service role to bypass RLS. Fix RLS policies instead. This code will be security-audited monthly.

## Files to Touch
- Components that enforce free-tier limits (trip creation, extraction, loyalty, export, webhooks, calendar)
- `src/components/billing/upgrade-banner.tsx` — smart dismissal logic
- New: `src/components/billing/upgrade-success.tsx` — post-checkout celebration
- `src/app/(dashboard)/settings/billing/page.tsx` — success state

## Quality
- TypeScript strict — `npx tsc --noEmit` must pass
- No `any` types
- `pnpm build` must pass
- Upsell copy should be helpful, not annoying. Explain what Pro unlocks in context.
