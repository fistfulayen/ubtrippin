# PRD 016 Phase 2 — Train Status (SNCF Open Data)

You are adding train status to UBTRIPPIN, a Next.js 16 app with Supabase, pnpm, and App Router.

**Phase 1 is already built** — flight status via FlightAware exists: `trip_item_status` table, status check cron, status badges, refresh endpoint. Extend these for trains.

**CRITICAL: Read `scripts/prompts/016-flightaware-reference.md` for the existing patterns. Follow the same architecture.**

**SECURITY RULE: Do NOT use createSecretClient() or service role to bypass RLS on user-facing routes.**

## SNCF Open Data API

Base URL: `https://api.sncf.com/v1`
Auth: Basic auth (key as username, empty password) via `Authorization: Basic {base64(key + ':')}`
Env var: `SNCF_API_KEY`

### Key endpoint
```
GET /coverage/sncf/vehicle_journeys?filter=vehicle_journey.has_code({train_number})&data_freshness=realtime
```

Response includes disruptions with real-time status.

### Alternative: SNCF Realtime API
```
GET https://api.sncf.com/v1/coverage/sncf/disruptions?since={datetime}
```

Filter disruptions by train number to find delays/cancellations.

## What to Build

### 1. SNCF Client (`src/lib/train-status.ts`)

```typescript
interface TrainStatusResult {
  status: 'on_time' | 'delayed' | 'cancelled' | 'unknown'
  delayMinutes: number | null
  platform: string | null
  estimatedDeparture: string | null
  estimatedArrival: string | null
  actualDeparture: string | null
  actualArrival: string | null
  raw: Record<string, unknown>
}
```

- Extract train number from trip item `details_json.train_number` (e.g., "TGV 6827", "TER 17583")
- Strip prefix, use numeric part for SNCF API query
- Map SNCF disruption effects to our status enum
- If no disruption found → `on_time`

### 2. Extend Status Check Cron (`src/app/api/internal/status-check/route.ts`)

Add train items to the existing cron:
- Query `trip_items` where `kind = 'train'` AND within 48h window
- Use same adaptive polling schedule as flights
- Call SNCF API instead of FlightAware
- Upsert into same `trip_item_status` table with `source = 'sncf'`

### 3. Status Badge Updates

The existing `ItemStatusBadge` component already works — it reads from `trip_item_status` regardless of source. But add:
- Show `platform` field for trains (in addition to gate/terminal for flights)
- Badge text: "Platform 3" instead of "Gate 2F"

### 4. Trip Status Summary

The existing `TripStatusSummary` component should already pick up train statuses since it reads from the same table. Verify this works.

### 5. Environment

Add `SNCF_API_KEY` to `.env.example` and `.env.local.example`.

## Important Notes

- SNCF API is free, no rate limits at our scale
- SNCF API may not have data for all trains (especially non-SNCF operators like Trenitalia)
- If SNCF returns no data, set status to `unknown` but DON'T show the badge (existing behavior hides unknown)
- The `trip_item_status` table already has a `platform` column — use it for trains
- Reuse the same `trip_item_status` table, same RLS policies, same status enum

## Do NOT

- Modify flight status logic
- Build MCP/CLI (Phase 3)
- Add new database tables (reuse trip_item_status)
- Bypass RLS
