# PRD 016 Phase 2 — SNCF Train Status via Open Data

## Context
Phase 1 shipped FlightAware integration for flight status. Phase 2 adds train status using SNCF Open Data (free, no API key needed).

## Data Source
- **API:** `https://data.sncf.com/api/explore/v2.1/`
- **Dataset:** `tgvmax` for schedules, `regularite-mensuelle-tgv` for on-time stats
- **No API key required** — fully open
- **Rate limit:** Be polite, cache aggressively

## What to Build

### 1. SNCF Status Lookup
Create `src/lib/train/sncf.ts`:
- `lookupTrainStatus(trainNumber: string, date: string)` → returns delay info, platform, status
- Query SNCF Open Data API for the specific train
- Parse response: departure station, arrival station, scheduled/actual times, delay minutes
- Cache results for 5 minutes (in-memory Map with TTL)

### 2. Integrate with Status Check Cron
Update `src/app/api/internal/status-check/route.ts`:
- For trip items where `provider_name` matches train operators (SNCF, TGV, Ouigo, Eurostar, Thalys, TER, Intercités):
  - Extract train number from `details_json.flight_number` or item title
  - Call SNCF API for status
  - Update `trip_items.status` field with delay info
- Same adaptive polling as flights: 48h→8h, 24h→2h, 4h→30min

### 3. Train Status Display
Update `src/components/trips/item-details/train-status.tsx` (create if needed):
- Show: On Time / Delayed X min / Cancelled
- Show platform number if available
- Same badge style as flight status

### 4. API Endpoint
`GET /api/v1/trains/:trainNumber/status?date=2026-03-01`
- Returns: `{ status, delay_minutes, platform, scheduled_departure, actual_departure, ... }`
- Rate limited, API key required

## Provider Detection
A trip item is a train if:
- `item_type === 'train'`
- OR `provider_name` matches: SNCF, TGV, OUIGO, Eurostar, Thalys, TER, Intercités, Trenitalia, Deutsche Bahn
- For Phase 2, only SNCF-family trains have real-time data. Others show "Status unavailable"

## Tech Stack
- Next.js 16 App Router, TypeScript, Tailwind CSS, pnpm
- Use `createUserScopedClient()` for user-facing routes
- Do NOT use createSecretClient() in user-facing routes. This code will be security-audited monthly.

## Quality
- `npx tsc --noEmit` must pass
- `pnpm build` must compile
- No `any` types
- Add error handling for SNCF API failures (return null/unknown, don't crash)
