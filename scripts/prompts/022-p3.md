# PRD 022 Phase 3 — E2E Test Expansion

## Context
We have 6 E2E spec files with ~28 tests. Phase 2 added 88 unit tests. Now expand E2E to cover all critical user flows.

## Existing Tests (e2e/tests/)
- auth.spec.ts — login page, auth redirect, callback
- trips.spec.ts — trips list, demo trip, trip detail CRUD
- guides.spec.ts — guides list, guide detail, entries
- settings.spec.ts — settings page, API keys, calendar
- activation.spec.ts — activation status
- email-inbound.spec.ts — email webhook processing

## New Tests to Write

### billing.spec.ts
- Navigate to /settings/billing
- Page loads without error
- Shows current plan (free or pro)
- "Upgrade" button visible for free users
- API: GET /api/v1/billing/portal returns valid URL (pro users only)

### loyalty.spec.ts
- Navigate to /loyalty
- Page loads without error
- API: POST /api/v1/me/loyalty — create a loyalty program (Delta SkyMiles, test number)
- API: GET /api/v1/me/loyalty — list shows the created program
- Verify masked number format (••••1234)
- API: DELETE /api/v1/me/loyalty/:id — cleanup
- API: GET /api/v1/loyalty/providers — returns provider list

### sharing.spec.ts
- API: create a trip, enable sharing
- Visit share URL (/share/:token) WITHOUT auth
- Share page loads and shows trip info
- Share page does not show edit controls
- Cleanup: delete trip

### family.spec.ts
- API: GET /api/v1/families — list families
- Page: /settings/family loads without error

### help.spec.ts
- Navigate to /help
- Page loads with all sections
- Search filters content
- Deep link /help#calendar scrolls to section

### webhooks.spec.ts
- API: POST /api/v1/webhooks — register a test webhook
- API: GET /api/v1/webhooks — list shows the webhook
- API: POST /api/v1/webhooks/:id/test — trigger test delivery
- API: GET /api/v1/webhooks/:id/deliveries — check delivery logged
- API: DELETE /api/v1/webhooks/:id — cleanup

### feedback.spec.ts
- Navigate to /feedback
- Page loads without error
- Submit form is visible

### mobile.spec.ts
- Test key pages at 375px viewport width:
  - /trips, /loyalty, /help, /settings, /feedback
  - No horizontal overflow
  - Nav is accessible (hamburger menu or similar)

## Helpers
Use existing `e2e/helpers/api.ts` for API calls. Use `e2e/fixtures/seed-trip.ts` and `seed-guide.ts` for data setup. Create new fixtures as needed.

## Important
- All tests must clean up after themselves (delete created resources)
- Use `test.skip()` if required env vars are missing
- Handle non-JSON responses gracefully (use the updated `parseBody` helper)
- Do NOT modify any app code — only files under `e2e/`
- Do NOT use createSecretClient() in test fixtures. Use the admin helper pattern from `e2e/helpers/supabase-admin.ts`.

## Quality
- `npx tsc --noEmit` must pass (for e2e tsconfig)
- All new tests should pass when run against https://www.ubtrippin.xyz
- Target: 15+ spec files total, 80+ E2E tests

## Commit
```
git add -A && git commit -m "feat(022-p3): E2E expansion — 15 spec files, 80+ tests"
git push origin feat/022-p3
```
