# PRD 024 — Feedback Fixes Round 2

## Context
Three feedback items from our first user (Chris Carlson). All merged into one phase.

## Existing Code
- Guides: `src/app/(dashboard)/guides/`, `src/components/maps/guide-map.tsx`
- Map uses react-leaflet with Leaflet CSS in `globals.css` and markers in `public/leaflet/`
- Feedback: `src/app/(dashboard)/feedback/` (if exists) or `src/app/feedback/`
- Trips: `src/app/(dashboard)/trips/[id]/page.tsx`, `src/components/trips/trip-item-card.tsx`
- Inbox: `src/app/(dashboard)/inbox/`
- Supabase Storage is available for image uploads

## Item 1: City Guide Map Empty (Bug)
The map in city guides renders empty. Diagnose and fix:
- Check that `guide_entries` have `latitude`/`longitude` populated
- Check that the `GuideMap` component receives entries with coordinates
- Check that `guide-map-section.tsx` actually renders `GuideMap` when entries have coordinates
- Verify Leaflet CSS is loading (check for height/width on container — Leaflet needs explicit height)
- Add a cover image picker to city guides (reuse the Unsplash image search pattern from trips: `src/components/trips/cover-image-picker.tsx`)
- Guide cover image should be stored in `cover_image_url` column on `guides` table

## Item 2: Edit Trip Item → Inbox (Feature)
Add an "Edit" button on each trip item card that links to the corresponding email in Inbox:
- In `src/components/trips/trip-item-card.tsx`, add a pencil/edit icon button
- Link should go to `/inbox?highlight=<source_email_id>` (or similar deep link)
- The trip item's `source_email_id` or `email_id` field connects it to the inbox
- Check the `trip_items` table schema for the correct foreign key to emails
- On the Inbox page, if `highlight` param is present, scroll to and highlight that email
- If no source email exists for the item (manually created), show "Edit" as disabled or hidden

## Item 3: Image Upload in Feedback (Feature)
Add optional screenshot/image upload to the feedback form:
- Create Supabase Storage bucket `feedback-images` (or use existing storage)
- Add `image_url` column to `feedback` table if not present (migration needed)
- In the feedback submission form, add an image upload field (max 1 image, 5MB, jpg/png/webp)
- Display the image on the feedback detail page
- **Cleanup:** When feedback status changes to "shipped", delete the image from Supabase Storage
  - Add this logic wherever feedback status is updated (likely a server action or API route)

## Migrations
If needed, create migrations in `supabase/migrations/` with timestamp prefix `20260301000004_`.

## Quality
- `npx tsc --noEmit` must pass
- `pnpm test` must pass (88 tests)
- `pnpm lint` must pass with 0 errors
- Do NOT use `createSecretClient()` in user-facing routes. Use `createUserScopedClient()` or `createClient()`. This code will be security-audited monthly.
- Do NOT modify test files

## Commit
```
git add -A && git commit -m "feat(024): feedback fixes — guide map, trip edit→inbox, feedback images"
```
