# PRD 021 Phase 1 â€” Pro Upsell System

You are building the upsell/upgrade experience for UBTRIPPIN, a Next.js 16 app with Supabase, pnpm, and App Router.

**The billing page already exists at `/settings/billing`.** Your job is to make it discoverable and wire upgrade prompts throughout the app.

**SECURITY RULE: Do NOT use createSecretClient() or service role to bypass RLS.**

## 1. Reusable Upgrade Card (`src/components/billing/upgrade-card.tsx`)

A shared component for all upsell points:

```typescript
interface UpgradeCardProps {
  title: string           // e.g., "Unlock unlimited trips"
  description: string     // e.g., "Pro gives you unlimited trips, flight alerts..."
  variant?: 'inline' | 'card' | 'banner'
  showEarlyAdopter?: boolean
  className?: string
}
```

- `inline`: single line with link, used for subtle prompts
- `card`: bordered card with title, description, CTA button
- `banner`: full-width slim banner (for top of dashboard)
- When `showEarlyAdopter` is true, fetch spots from `/api/v1/billing/subscription` and show: "ðŸŽ‰ Early adopter: $10/year (X spots left)" with a progress indicator
- CTA button always links to `/settings/billing`
- Use existing shadcn/ui components (Button, Card from `src/components/ui/`)

## 2. Global Upgrade Banner (`src/components/billing/upgrade-banner.tsx`)

For free-tier users, show a slim banner below the nav bar on all dashboard pages:

```
ðŸŽ‰ Early adopter pricing: $10/year for unlimited everything. Only X spots left.  [Upgrade â†’]
```

- Dismissible (localStorage key `upgrade-banner-dismissed`, reappears after 7 days)
- Fetch user tier: use the existing profile/session data from the dashboard layout
- Hidden for Pro users
- When early adopter spots = 0, change to: "Upgrade to Pro â€” $2.99/month [Upgrade â†’]"

Wire into: `src/app/(dashboard)/layout.tsx` â€” render after the nav, before `{children}`

To get the user's tier, check how other dashboard pages get it. Look at existing patterns in `src/app/(dashboard)/trips/page.tsx` or `src/app/(dashboard)/loyalty/page.tsx` for how they query `profiles`.

## 3. Settings Nav â€” Add Billing

Add "Billing" to the settings navigation. Check `src/components/settings/settings-nav.tsx` â€” it may already have a billing entry from Phase 2 of PRD 005. If so, verify it works. If not, add it with icon and link to `/settings/billing`.

## 4. Trips Page â€” Limit Card

In `src/app/(dashboard)/trips/page.tsx`:

When free user has 3+ active trips, add an UpgradeCard above or instead of the "New Trip" action:

```
title: "You've reached the free trip limit"
description: "Upgrade to Pro for unlimited trips, live flight status, and more."
variant: 'card'
showEarlyAdopter: true
```

Keep the "+ New Trip" button but show the upgrade card prominently.

## 5. Loyalty Page â€” Fix Dead Link

In `src/components/loyalty/loyalty-vault.tsx` or `src/app/(dashboard)/loyalty/page.tsx`:

The amber text "Free tier supports 3 loyalty programs. Upgrade to Pro for unlimited." currently links nowhere. Replace it with:

```tsx
<UpgradeCard
  title="Unlock unlimited loyalty programs"
  description="Free tier supports 3 programs. Upgrade to Pro for unlimited loyalty tracking across all travelers."
  variant="card"
  showEarlyAdopter={true}
/>
```

Show this when `!isPro && programs.length >= 3`.

## 6. City Guides Page â€” Subtle Pro Badge

In `src/app/(dashboard)/guides/page.tsx`:

If there's a free tier limit on guides, add the same UpgradeCard pattern. If guides are unlimited on free tier, add a subtle note: "Pro features: PDF export, sharing" as an inline variant.

## 7. Family Settings â€” Pro Gate

In `src/components/settings/family-settings.tsx`:

Replace or enhance the existing Pro gate with:

```tsx
<UpgradeCard
  title="Family sharing is a Pro feature"
  description="Share trips, loyalty programs, and city guides with your family."
  variant="card"
  showEarlyAdopter={true}
/>
```

## 8. Webhooks â€” Pro Gate

In `src/components/settings/webhooks-section.tsx`:

```tsx
<UpgradeCard
  title="Webhooks are a Pro feature"  
  description="Let your AI agents react to trip updates in real-time."
  variant="card"
  showEarlyAdopter={true}
/>
```

## Design

- Use the existing indigo/slate color palette
- CTA buttons: indigo-600 background, white text (primary button style)
- Early adopter badge: small green pill or highlight
- Progress bar for early adopter spots: thin, indigo
- Cards: white background, slate-200 border, rounded-lg
- Keep it clean. One CTA per card. No aggressive marketing.

## Important

- Check `subscription_tier` on `profiles` (NOT `tier`)
- Early adopter data from `GET /api/v1/billing/subscription` â†’ `earlyAdopterSpotsRemaining`
- All links go to `/settings/billing`
- Use `createClient()` for server components
- pnpm, run `npx tsc --noEmit` before committing
- Look at existing code patterns before inventing new ones
