# PRD 015 Phase 1 — Family CRUD + Invite Flow + UI

You are building Phase 1 of Family Sharing for UBTRIPPIN, a Next.js 16 app with Supabase, pnpm, and App Router.

## What to Build

### 1. Database Migration (`supabase/migrations/20260301000000_family_sharing.sql`)

Create tables:

```sql
-- families
CREATE TABLE families (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  created_by uuid NOT NULL REFERENCES auth.users(id),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

ALTER TABLE families ENABLE ROW LEVEL SECURITY;

-- family_members
CREATE TABLE family_members (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  family_id uuid NOT NULL REFERENCES families(id) ON DELETE CASCADE,
  user_id uuid REFERENCES auth.users(id),
  role text NOT NULL DEFAULT 'member' CHECK (role IN ('admin', 'member')),
  invited_email text NOT NULL,
  invited_by uuid NOT NULL REFERENCES auth.users(id),
  invite_token text UNIQUE,
  accepted_at timestamptz,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  UNIQUE(family_id, user_id)
);

CREATE INDEX idx_family_members_user ON family_members(user_id);
CREATE INDEX idx_family_members_token ON family_members(invite_token);

ALTER TABLE family_members ENABLE ROW LEVEL SECURITY;
```

Add author columns to guide_places:
```sql
ALTER TABLE guide_places ADD COLUMN IF NOT EXISTS author_id uuid REFERENCES auth.users(id);
ALTER TABLE guide_places ADD COLUMN IF NOT EXISTS author_name text;
```

Create `is_family_member()` SECURITY DEFINER function:
```sql
CREATE OR REPLACE FUNCTION is_family_member(target_user_id uuid)
RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1 FROM family_members fm1
    JOIN family_members fm2 ON fm1.family_id = fm2.family_id
    WHERE fm1.user_id = auth.uid()
      AND fm2.user_id = target_user_id
      AND fm1.accepted_at IS NOT NULL
      AND fm2.accepted_at IS NOT NULL
  )
$$ LANGUAGE sql SECURITY DEFINER STABLE;
```

RLS policies:
- `families`: SELECT for members, INSERT for creator, UPDATE for admin
- `family_members`: SELECT for same-family members, DELETE for self
- Add family read policies to `trips`, `loyalty_programs`, `guides` tables using `is_family_member(user_id)`
- Trip items: family members get editor access (INSERT, UPDATE) on trips owned by family members

### 2. API Routes

All under `src/app/api/v1/`:

- `families/route.ts` — GET (list user's families), POST (create family, Pro gate)
- `families/[id]/route.ts` — GET (family + members), PATCH (rename, admin only), DELETE (admin only)
- `families/[id]/members/route.ts` — GET (list members), POST (invite member, admin only)
- `families/[id]/members/[uid]/route.ts` — PATCH (change role, admin only), DELETE (remove/leave)
- `family-invites/[token]/route.ts` — GET (preview invite), POST (accept invite)

Use `src/lib/supabase/server.ts` for authenticated requests. Use `src/lib/supabase/service.ts` (createSecretClient) ONLY for the invite acceptance flow where we need to update family_members regardless of RLS.

Pro gate: only Pro users can CREATE families. Free users can accept invites and be members.

Invite flow:
- POST to members creates a family_members row with invite_token (nanoid)
- Send invite email via Resend (use existing email patterns in `src/lib/email/`)
- GET invite preview returns family name + inviter name
- POST accept sets user_id + accepted_at, nulls invite_token

### 3. UI Pages

**`src/app/(dashboard)/settings/family/page.tsx`**
- List families user belongs to
- "Create a family" button (Pro gate)
- For each family: name, member list (name, email, role, join date), pending invites
- Invite member form (email input)
- Leave family button
- Admin actions: remove member, change role, rename family

**`src/app/(auth)/invite/family/[token]/page.tsx`**
- Public page showing invite preview
- "Join [Family Name]" button for logged-in users
- Redirect to signup with `?family_invite=[token]` for non-logged-in users

**Invite email component** — `src/components/emails/family-invite.tsx` (React Email)
- Subject: "[Name] invited you to join [Family Name] on UBTRIPPIN"
- Body includes "Sharing is caring" messaging
- CTA button links to `/invite/family/[token]`

### 4. Trip Dashboard Updates

Update `src/app/(dashboard)/trips/page.tsx`:
- Fetch family members' trips alongside user's own trips
- Show a small badge on family trips: family icon + owner name
- Family trips are interleaved with user's own trips (sorted by date as usual)

### 5. Settings Navigation

Add "Family" to the settings nav (use existing `src/components/settings/settings-nav.tsx` pattern if it exists, or the sidebar nav).

## Important Patterns

- Use `createClient()` from `src/lib/supabase/server.ts` for all authenticated routes
- Use `createSecretClient()` from `src/lib/supabase/service.ts` only for invite acceptance
- Server actions return void (not `{ error }`). Throw errors or redirect.
- Use nanoid for invite tokens (already a dependency)
- Check Pro tier via `subscription_tier` column on `profiles` table (NOT `tier`)
- Existing helper: `is_trip_owner()` function — follow same SECURITY DEFINER pattern
- pnpm package manager
- Run `npx tsc --noEmit` before committing to verify no type errors
- All family-related routes need proper error handling and auth checks

## Do NOT

- Touch billing/payment code
- Modify existing RLS policies — only ADD new ones
- Add any granular privacy controls (no sharing toggles, no per-category controls)
- Break existing trip/loyalty/guide functionality
