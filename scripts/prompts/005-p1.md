# PRD 005 Phase 1 — Stripe Checkout, Webhooks, Billing API

You are building Stripe subscription billing for UBTRIPPIN, a Next.js 16 app with Supabase, pnpm, and App Router.

**SECURITY RULE: Do NOT use createSecretClient() or service role to bypass RLS. Fix RLS policies instead. This code will be security-audited monthly.**

## Environment Variables (already configured)

- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` — Stripe publishable key
- `STRIPE_SECRET_KEY` — Stripe secret key
- `STRIPE_WEBHOOK_SECRET` — Webhook signing secret
- `STRIPE_PRICE_ANNUAL` — $24.99/year price ID
- `STRIPE_PRICE_EARLY_ADOPTER` — $10/year price ID (first 100 subscribers)
- `STRIPE_PRICE_MONTHLY` — $2.99/month price ID

## 1. Database Migration (`supabase/migrations/20260228000001_stripe_billing.sql`)

```sql
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS stripe_customer_id text UNIQUE;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS stripe_subscription_id text;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS subscription_current_period_end timestamptz;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS subscription_grace_until timestamptz;

CREATE INDEX IF NOT EXISTS idx_profiles_stripe_customer ON profiles(stripe_customer_id);
CREATE INDEX IF NOT EXISTS idx_profiles_stripe_subscription ON profiles(stripe_subscription_id);

-- subscription_tier already exists with values 'free' and 'pro'
-- Add 'grace' and 'paused' as valid values (it's a text column, no constraint to alter)

-- Early adopter counter: count Pro subscribers
-- No separate table needed — just COUNT(*) WHERE subscription_tier IN ('pro', 'grace')
```

RLS: These new columns are on the existing `profiles` table which already has RLS. No new policies needed — users can already read their own profile.

## 2. Install Stripe SDK

Run: `pnpm add stripe`

## 3. Stripe Client (`src/lib/stripe.ts`)

```typescript
import Stripe from 'stripe'

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2025-12-15.clover', // Match the API version in Stripe Dashboard
  typescript: true,
})
```

## 4. API Routes

### `POST /api/v1/checkout` (`src/app/api/v1/checkout/route.ts`)

- Auth required (cookie-based via `createClient()`)
- Check user's `subscription_tier` — if already Pro, return error
- Get or create Stripe Customer (using `stripe_customer_id` from profile, or create new and store)
- Count current Pro subscribers for early adopter check: if < 100, offer early adopter price
- Create Checkout Session with:
  - `client_reference_id`: user's UUID
  - `customer`: Stripe customer ID
  - `line_items`: the chosen price (from request body `priceId`)
  - `mode`: 'subscription'
  - `success_url`: `{origin}/settings/billing?upgraded=true`
  - `cancel_url`: `{origin}/settings/billing`
  - `allow_promotion_codes`: true
- Return `{ url: session.url }`

### `POST /api/v1/webhooks/stripe` (`src/app/api/v1/webhooks/stripe/route.ts`)

- **Do NOT use createClient() here** — webhooks have no user session
- **Use createSecretClient()** — this is a legitimate use (external service callback, no user context)
- Verify webhook signature using `stripe.webhooks.constructEvent(body, sig, STRIPE_WEBHOOK_SECRET)`
- Handle all 14 events:

| Event | Action |
|---|---|
| `checkout.session.completed` | Look up user by `client_reference_id`, set `subscription_tier='pro'`, store `stripe_customer_id` and `stripe_subscription_id` |
| `customer.created` | Store `stripe_customer_id` on profile (match by email) |
| `customer.updated` | Update stored email if changed |
| `customer.subscription.created` | If status is `active`, set Pro. If `incomplete`, log only |
| `customer.subscription.updated` | Update `subscription_tier` based on subscription status. Update `subscription_current_period_end` |
| `customer.subscription.deleted` | Set `subscription_tier='free'`, clear `stripe_subscription_id` |
| `customer.subscription.paused` | Set `subscription_tier='paused'` |
| `customer.subscription.resumed` | Set `subscription_tier='pro'` |
| `customer.subscription.trial_will_end` | Log (future use for trial emails) |
| `invoice.created` | Log |
| `invoice.finalized` | Log |
| `invoice.paid` | Set `subscription_tier='pro'`, update `subscription_current_period_end`, clear `subscription_grace_until` |
| `invoice.payment_failed` | Set `subscription_tier='grace'`, set `subscription_grace_until` to now + 3 days |
| `invoice.payment_action_required` | Log (email sending is Phase 2) |

- All handlers must be **idempotent** — check current state before updating
- Return 200 for all handled events, 400 for signature verification failure

### `GET /api/v1/billing/portal` (`src/app/api/v1/billing/portal/route.ts`)

- Auth required
- Get user's `stripe_customer_id` from profile
- Create Stripe Customer Portal session: `stripe.billingPortal.sessions.create({ customer, return_url })`
- Return `{ url: session.url }`

### `GET /api/v1/billing/subscription` (`src/app/api/v1/billing/subscription/route.ts`)

- Auth required
- Return current subscription status from profile: `subscription_tier`, `subscription_current_period_end`, `subscription_grace_until`
- Include early adopter count: `SELECT COUNT(*) FROM profiles WHERE subscription_tier IN ('pro', 'grace')` — return `{ earlyAdopterSpotsRemaining: Math.max(0, 100 - count) }`

### `GET /api/v1/billing/prices` (`src/app/api/v1/billing/prices/route.ts`)

- Public (no auth required)
- Return available prices with early adopter availability:
  ```json
  {
    "prices": [
      { "id": "price_xxx", "name": "Monthly", "amount": 299, "interval": "month" },
      { "id": "price_xxx", "name": "Annual", "amount": 2499, "interval": "year" },
      { "id": "price_xxx", "name": "Early Adopter", "amount": 1000, "interval": "year", "available": true, "spotsRemaining": 87 }
    ]
  }
  ```
- Early adopter `available` is false when 100+ Pro subscribers exist

## 5. Next.js Config

The webhook route needs the raw body for signature verification. In the route file:
```typescript
export const runtime = 'nodejs' // Not edge — Stripe SDK needs Node
export const dynamic = 'force-dynamic'

// Read raw body for signature verification
const body = await request.text()
const sig = request.headers.get('stripe-signature')!
```

## Important Patterns

- Use `createClient()` from `src/lib/supabase/server.ts` for authenticated routes
- Use `createSecretClient()` from `src/lib/supabase/service.ts` ONLY for the webhook handler (no user session available)
- Check `subscription_tier` on `profiles` table (NOT `tier`)
- pnpm package manager
- Run `npx tsc --noEmit` before committing
- All amounts in cents (Stripe convention)

## Do NOT

- Build any UI (that's Phase 2)
- Send emails (that's Phase 2)
- Add trial logic (future feature)
- Modify existing RLS policies
- Store card numbers or payment details (Stripe handles all of that)
