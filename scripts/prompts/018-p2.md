# PRD 018 Phase 2 — Agent Swarm Automated Review

## Context
Phase 1 is complete: `spawn-agent.sh`, `check-agents.sh`, `cleanup-agents.sh`, `monitor-cron.sh`, and `agent-review.yml` GitHub Action. The swarm successfully built PRD 015 across 3 agents.

Current gap: when agents finish, monitor-cron pushes branches and creates PRs, but the automated review workflow (`agent-review.yml`) needs improvement.

## What to Build

### 1. Fix `agent-review.yml` GitHub Action
- Currently triggers on `labeled` event only — should also trigger on `pull_request: opened` when branch matches `feat/*` or `fix/*`
- Add Gemini Code Assist review (already installed on repo — it auto-reviews PRs)
- Add Claude review step using `anthropic/claude-sonnet-4-6` via API:
  - Fetch PR diff via `gh pr diff $PR_NUMBER`
  - Send to Claude API with review prompt (security focus: no RLS bypasses, no `createSecretClient()` on happy paths, no `any` types)
  - Post review as PR comment
- Env var needed: `ANTHROPIC_API_KEY` (already in GitHub Secrets)

### 2. Review Counting in `check-agents.sh`
- Already partially implemented — verify it counts Gemini + Claude reviews
- Definition of "ready to merge": CI passed + ≥2 approved reviews (Gemini + Claude)
- When ready: post a Signal message to Ian via the agent summary, NOT auto-merge

### 3. Improved `monitor-cron.sh`
- Better branch detection: check for `AGENTS.md` or `.codex/` artifacts that indicate Codex completion
- Cleaner commit messages on push
- Handle merge conflicts gracefully (alert, don't crash)

## Tech Stack
- Bash scripts in `scripts/`
- GitHub Actions YAML in `.github/workflows/`
- `gh` CLI for GitHub API operations
- `curl` for Claude API calls

## Security
- Do NOT use `createSecretClient()` or service role to bypass RLS. Fix RLS policies instead. This code will be security-audited monthly.
- All review prompts must include security checklist
- Never auto-merge — human approval required

## Quality
- Scripts must be shellcheck-clean
- Idempotent (safe to re-run)
- Test with `bash -n scripts/*.sh` before declaring done
