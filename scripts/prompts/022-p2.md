# PRD 022 Phase 2 — Unit Test Foundation with Vitest

## Setup

1. Install Vitest: `pnpm add -D vitest @vitest/coverage-v8`
2. Create `vitest.config.ts` at the project root:
```typescript
import { defineConfig } from 'vitest/config'
import path from 'path'

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    include: ['src/**/*.test.ts'],
    coverage: {
      provider: 'v8',
      include: ['src/lib/**/*.ts'],
      exclude: ['src/lib/supabase/**'],
    },
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
})
```
3. Add to `package.json` scripts: `"test": "vitest run"`, `"test:watch": "vitest"`, `"test:coverage": "vitest run --coverage"`

## Priority Modules to Test

Write unit tests for these 8 modules. Each module gets its own `.test.ts` file next to the source file.

### 1. `src/lib/api/auth.ts` → `src/lib/api/auth.test.ts`
- `hashApiKey()` produces consistent SHA-256 hex output
- `hashApiKey()` produces different hashes for different inputs
- `isAuthError()` returns true for NextResponse, false for AuthResult
- Test with empty string, whitespace, special characters

### 2. `src/lib/usage/limits.ts` → `src/lib/usage/limits.test.ts`
- Mock the Supabase client (don't call real DB)
- Test `checkTripLimit()` returns true when under limit, false when at limit
- Test `checkExtractionLimit()` same pattern
- Test edge case: exactly at the limit boundary
- Mock pattern: create a mock client that returns `{ data: [...], error: null }`

### 3. `src/lib/images/provider-logo.ts` → `src/lib/images/provider-logo.test.ts`
- `getProviderLogos()` returns correct URL for known airlines (AF, DL, UA, BA)
- Returns Google Favicon fallback for non-airline providers (SNCF, Sixt, Marriott)
- Handles unknown providers gracefully
- Extracts IATA code from flight numbers correctly ("AF1234" → "AF", "DL 567" → "DL")

### 4. `src/lib/billing.ts` → `src/lib/billing.test.ts` (if this file exists)
- Tier detection from subscription_tier column
- Grace period calculation
- Early adopter eligibility check

### 5. `src/lib/calendar/` → test the iCal generation
- Valid ICS output format
- Correct DTSTART/DTEND in UTC
- Flight details in DESCRIPTION (airline, flight#, terminals, gates, confirmation)
- Multiple items generate multiple VEVENTs

### 6. `src/lib/trips/access.ts` → `src/lib/trips/access.test.ts`
- `resolveTripWriteAccess()` with mock data:
  - Owner → allowed
  - Editor collaborator → allowed  
  - Viewer collaborator → not allowed (reason: 'viewer')
  - Non-participant → not allowed (reason: 'not_found')
  - Family member → allowed

### 7. `src/lib/ai/extract-travel-data.ts` → test email parsing helpers
- Only test pure functions (date parsing, field extraction), NOT the AI call
- Test year inference (no year in email → use next upcoming occurrence)
- Test provider name extraction from email subjects
- Test IATA code extraction from flight strings

### 8. `src/lib/webhooks.ts` → `src/lib/webhooks.test.ts`
- HMAC signature generation is deterministic
- Payload serialization matches expected format
- Version field is always "1"

## Mock Strategy

For functions that need Supabase:
```typescript
const mockClient = {
  from: vi.fn().mockReturnThis(),
  select: vi.fn().mockReturnThis(),
  eq: vi.fn().mockReturnThis(),
  single: vi.fn().mockResolvedValue({ data: {...}, error: null }),
} as unknown as SupabaseClient
```

For functions that call external APIs (AI, Stripe): mock entirely, test only the logic around the call.

## CI Integration

Add to `.github/workflows/security.yml` (or create a new `test.yml`):
```yaml
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm test
```

## Quality
- `npx tsc --noEmit` must pass
- `pnpm test` must pass with 0 failures
- Target: ≥50 test cases across the 8 files
- No `any` types in test files
- Do NOT use createSecretClient() or service role to bypass RLS. This code will be security-audited monthly.

## Commit
```
git add -A && git commit -m "feat(022-p2): unit test foundation — Vitest setup + 50+ tests across 8 modules"
git push origin feat/022-p2
```
