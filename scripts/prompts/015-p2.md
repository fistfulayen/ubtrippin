# PRD 015 Phase 2 — Family Loyalty + Profiles + Guides + Email Routing

You are building Phase 2 of Family Sharing for UBTRIPPIN, a Next.js 16 app with Supabase, pnpm, and App Router.

**Phase 1 is already built** — `families` and `family_members` tables exist, `is_family_member()` function exists, basic CRUD API and UI exist.

## What to Build

### 1. Family Loyalty API (`src/app/api/v1/families/[id]/loyalty/`)

- `route.ts` — GET: returns all loyalty programs across all family members. Each program includes `traveler_name`, `provider_name`, `provider_key`, `program_number_masked`, and `user_id`. Auth: must be a member of this family.
- `lookup/route.ts` — GET `?provider=airfrance`: returns each family member's best match for that provider. Use the existing loyalty matching logic in `src/lib/loyalty/loyalty-matching.ts`. Include alliance-aware fallback (e.g., SkyTeam search returns Air France + KLM + Delta programs).

**Important:** Loyalty numbers returned to family members should be **plaintext** (decrypted), not masked. Agents need actual numbers to auto-fill bookings. Use the decryption logic from `src/lib/loyalty/loyalty-crypto.ts`.

### 2. Family Profiles API (`src/app/api/v1/families/[id]/profiles/route.ts`)

- GET: returns all family members' traveler preferences. Query the `profiles` table for each family member. Return array with `user_id`, `full_name`, `seat_preference`, `meal_preference`, `home_airport`, etc.
- Auth: must be a member of this family.

### 3. Family Guides API (`src/app/api/v1/families/[id]/guides/route.ts`)

- GET: returns all city guides from all family members. Each guide includes the owner's name.
- Guide entries should include `author_name` when available (populated from `guide_places.author_name`).

### 4. Family Trips API (`src/app/api/v1/families/[id]/trips/route.ts`)

- GET: returns all trips from all family members. Each trip includes `owner` object with `user_id` and `full_name`.
- Support same query params as the main trips endpoint (upcoming/past/current).

### 5. Email Routing Enhancement

Update the email extraction/routing logic (likely in `src/app/api/inbound/route.ts` or similar) to check family trips when routing new confirmations:

1. When a new confirmation email arrives, after checking the user's own trips...
2. Also check trips belonging to family members
3. Match on: overlapping dates, same destination city, shared travelers
4. If a family member's trip matches → add the item to that trip
5. If no match → create a new trip owned by the person who forwarded the email

### 6. Guide Attribution

When creating new guide entries (places), auto-populate `author_id` and `author_name` from the authenticated user. Update the guide creation logic in the existing API routes.

Update the guide UI to show "Added by [Name]" for each place entry when viewing a guide that has entries from multiple family members.

## Important Patterns

- Use `createClient()` from `src/lib/supabase/server.ts` for authenticated requests
- Use `createSecretClient()` from `src/lib/supabase/service.ts` only when bypassing RLS is necessary (e.g., querying across family members if RLS doesn't cover it — but Phase 1 RLS should handle reads)
- Family membership verification: query `family_members` where `family_id` matches AND `user_id = auth.uid()` AND `accepted_at IS NOT NULL`
- Loyalty decryption: use `decryptLoyaltyNumber()` from `src/lib/loyalty/loyalty-crypto.ts` — requires `LOYALTY_ENCRYPTION_KEY` env var
- Check `subscription_tier` on `profiles` (NOT `tier`) for Pro checks
- pnpm package manager
- Run `npx tsc --noEmit` before committing

## Do NOT

- Modify Phase 1 tables or APIs (families, family_members CRUD)
- Add privacy toggles or per-category sharing controls
- Touch billing/payment code
- Break existing non-family API endpoints
