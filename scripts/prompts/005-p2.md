# PRD 005 Phase 2 â€” Billing UI, Upgrade Prompts, Grace Period

You are building the billing UI for UBTRIPPIN, a Next.js 16 app with Supabase, pnpm, and App Router.

**Phase 1 is already built** â€” Stripe checkout, webhook handler, billing API endpoints all exist.

**SECURITY RULE: Do NOT use createSecretClient() or service role to bypass RLS. Fix RLS policies instead. This code will be security-audited monthly.**

## 1. Billing Settings Page (`src/app/(dashboard)/settings/billing/page.tsx`)

Add a "Billing" tab to settings navigation (alongside General, Traveler Profile, Family, Webhooks).

### Free User View
```
Current Plan: Free
3 active trips Â· 10 extractions/month Â· 3 loyalty programs

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Upgrade to Pro                                       â”‚
â”‚                                                       â”‚
â”‚  Unlimited trips, loyalty vault, train status,        â”‚
â”‚  family creation, API access, webhooks, and           â”‚
â”‚  everything we build.                                 â”‚
â”‚                                                       â”‚
â”‚  ğŸ‰ Early adopter: $10/year (X spots remaining)      â”‚
â”‚  â”€â”€â”€ or â”€â”€â”€                                           â”‚
â”‚  $2.99/month Â· $24.99/year                            â”‚
â”‚                                                       â”‚
â”‚  [Get Early Adopter â†’ $10/year]                       â”‚
â”‚  [Go Monthly â†’ $2.99/mo]  [Go Annual â†’ $24.99/yr]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Early adopter button is primary/highlighted when spots remain
- When 100 spots are gone, early adopter section disappears
- Buttons call `POST /api/v1/checkout` with the chosen `priceId`, then `window.location.href = url`

### Pro User View
```
Current Plan: Pro ($24.99/year)
Next billing: March 27, 2027

[Manage Billing â†’]  (opens Stripe Customer Portal)
```

- "Manage Billing" calls `GET /api/v1/billing/portal` then redirects

### Grace Period View
```
âš ï¸ Payment Failed

Your payment method was declined. You have Pro access until [date].
Update your payment method to continue.

[Update Payment Method â†’]  (opens Stripe Customer Portal)
```

### Paused View
```
Your subscription is paused.

[Resume Subscription â†’]  (opens Stripe Customer Portal)
```

## 2. Success State

When URL has `?upgraded=true`:
- Show confetti animation (reuse existing confetti from onboarding if available, or add `canvas-confetti` package)
- Toast: "Welcome to Pro! All limits have been removed."
- Clear the query param after showing

## 3. Upgrade Prompts â€” Wire Existing Dead Ends

Find all existing "Upgrade to Pro" buttons/links throughout the app and wire them to the checkout flow. These exist in:

- **Trip limit** (`src/app/(dashboard)/trips/page.tsx` or similar) â€” when user has 3 active trips
- **Extraction limit** â€” when monthly extraction count reached
- **Loyalty page** (`src/app/(dashboard)/loyalty/page.tsx`) â€” the upsell banner for free users
- **Family creation** (`src/components/settings/family-settings.tsx`) â€” Pro gate on create
- **Webhook settings** â€” if Pro-gated

Each prompt should link to `/settings/billing` (not directly to Stripe â€” let the billing page handle checkout).

## 4. Early Adopter Counter Component (`src/components/billing/early-adopter-counter.tsx`)

A reusable component showing:
```
ğŸ‰ X of 100 early adopter spots remaining
[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘] 87/100
```

- Fetches from `GET /api/v1/billing/subscription` (the `earlyAdopterSpotsRemaining` field)
- Progress bar fills as spots are taken
- When 0 remaining, component returns null (disappears)
- Use on billing page and optionally on landing page

## 5. Settings Navigation Update

Add "Billing" to `src/components/settings/settings-nav.tsx` between "Family" and "Webhooks".

## 6. Grace Period Cron

Create a migration or edge function that runs daily to downgrade expired grace periods:

```sql
-- Could be a pg_cron job or an API endpoint called by OpenClaw cron
UPDATE profiles 
SET subscription_tier = 'free', subscription_grace_until = NULL
WHERE subscription_tier = 'grace' 
  AND subscription_grace_until < NOW();
```

If using an API endpoint: `POST /api/internal/billing/expire-grace` â€” called by cron, no auth (internal only).

## Important Patterns

- Use `createClient()` from `src/lib/supabase/server.ts` for authenticated requests
- Check `subscription_tier` on `profiles` table (NOT `tier`)
- Use existing UI component library (shadcn/ui components in `src/components/ui/`)
- Follow existing settings page patterns
- pnpm package manager
- Run `npx tsc --noEmit` before committing

## Do NOT

- Modify the Stripe webhook handler (Phase 1)
- Add email sending (separate feature)
- Build trial logic
- Bypass RLS with service client
