# PRD 006 Phase 2 — City Guides Enrichment

## Context
City Guides Phase 1 is complete: CRUD UI, share pages, PDF/MD export, geo-queries, PWA share target, API endpoints. DB schema already has `latitude`, `longitude`, `google_place_id`, `address` columns on `guide_entries`.

## What to Build

### 1. Google Places Autocomplete on Entry Form
- In `src/app/(dashboard)/guides/[id]/entry-form.tsx`, add a Google Places autocomplete input for the `name` field
- When user selects a place: auto-fill `address`, `latitude`, `longitude`, `google_place_id`, `website_url`
- Use Google Places API (New) — `searchText` endpoint via server action to avoid exposing API key
- Server action at `src/app/(dashboard)/guides/[id]/actions.ts` — add `searchPlaces(query: string, city: string)` 
- Env var: `GOOGLE_PLACES_API_KEY` (already exists in .env.local)
- Graceful degradation: if Places API fails or user skips, manual entry still works
- DO NOT add `NEXT_PUBLIC_*` env vars — all Places calls go through server action

### 2. Map View on Share Page
- Add a map to the public share page at `src/app/share/guide/[token]/page.tsx`
- Use Leaflet + OpenStreetMap (free, no API key needed) — `npm install leaflet react-leaflet`
- Add `@types/leaflet` as devDependency
- Only show map when at least 1 entry has coordinates
- Markers for each entry with coordinates, popup shows name + category
- Toggle between list view and map view
- The map component must be a client component (dynamic import with `ssr: false`)

### 3. Cover Image from Unsplash
- Same pattern as trips — reuse existing `src/lib/images/unsplash.ts`
- Add image search button to guide edit page
- Search query: guide city name
- PATCH guide with `cover_image_url`

### 4. Import from Forwarded Emails → `to_try` Entries
- When the email extraction pipeline processes a forwarded recommendation email (not a booking), create a `guide_entry` with `status: 'to_try'` and `source: 'import'`
- Add detection logic in the email processing route: if email contains restaurant/place recommendations but NOT booking confirmations, route to guide entry creation
- Entry goes into the guide matching the city, or creates a new guide if none exists
- Set `recommended_by` from the email sender name

## Tech Stack
- Next.js 16 App Router, TypeScript, Tailwind CSS, pnpm
- Supabase (PostgreSQL) with RLS — use `createClient()` from `src/lib/supabase/server.ts`
- Do NOT use `createSecretClient()` or service role to bypass RLS. Fix RLS policies instead. This code will be security-audited monthly.

## Excluded from This Phase (Phase 3)
- Browser extension
- iOS Shortcut
- "Friends nearby" query
- Featured/collaborative/follow guides

## Files to Touch
- `src/app/(dashboard)/guides/[id]/entry-form.tsx` — Places autocomplete
- `src/app/(dashboard)/guides/[id]/actions.ts` — searchPlaces server action
- `src/app/share/guide/[token]/page.tsx` — map view
- `src/lib/images/unsplash.ts` — reuse for guide covers
- Email processing route (detection for recommendations vs bookings)
- New: `src/components/maps/guide-map.tsx` — Leaflet map component
- `package.json` — add leaflet, react-leaflet, @types/leaflet

## Quality
- TypeScript strict — `npx tsc --noEmit` must pass
- No `any` types
- All new server actions must validate input
- Test with `pnpm build` before declaring done
