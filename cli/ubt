#!/usr/bin/env bash
#
# ubt — UB Trippin CLI
# Talk directly to Supabase REST API
#
UBT_VERSION="2.0.0"
set -euo pipefail

# Load config
CONFIG_FILE="${UBT_CONFIG:-$HOME/.ubt/config}"
if [ -f "$CONFIG_FILE" ]; then
  source "$CONFIG_FILE"
fi

# Can also be set via env vars
SUPABASE_URL="${UBT_SUPABASE_URL:-${SUPABASE_URL:-}}"
SUPABASE_KEY="${UBT_SUPABASE_KEY:-${SUPABASE_KEY:-}}"

if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ]; then
  # Try loading from .env.local in the repo
  REPO_DIR="$(cd "$(dirname "$(readlink -f "$0")")/.." && pwd)"
  if [ -f "$REPO_DIR/.env.local" ]; then
    SUPABASE_URL=$(grep '^NEXT_PUBLIC_SUPABASE_URL=' "$REPO_DIR/.env.local" | cut -d= -f2- | tr -d '"')
    SUPABASE_KEY=$(grep '^SUPABASE_SECRET_KEY=' "$REPO_DIR/.env.local" | cut -d= -f2- | tr -d '"')
  fi
fi

if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ]; then
  echo "Error: Supabase credentials not configured." >&2
  echo "Set UBT_SUPABASE_URL and UBT_SUPABASE_KEY, or create ~/.ubt/config" >&2
  exit 1
fi

API="${SUPABASE_URL}/rest/v1"
API_V1="${UBT_API_URL:-https://www.ubtrippin.xyz/api/v1}"
API_V1="${API_V1%/}"
APP_URL="${UBT_APP_URL:-https://www.ubtrippin.xyz}"

# UBT_API_KEY enables v1 REST API calls (required for merge, move, etc.)
# Set in config or via env: export UBT_API_KEY=ubt_...
UBT_API_KEY="${UBT_API_KEY:-}"
if [ -z "$UBT_API_KEY" ] && [ -f "$CONFIG_FILE" ]; then
  UBT_API_KEY=$(grep '^UBT_API_KEY=' "$CONFIG_FILE" 2>/dev/null | cut -d= -f2- | tr -d '"')
fi

# Helpers
_curl() {
  curl -s "$@" \
    -H "apikey: ${SUPABASE_KEY}" \
    -H "Authorization: Bearer ${SUPABASE_KEY}" \
    -H "Content-Type: application/json"
}

# v1 API calls — requires UBT_API_KEY
_require_api_key() {
  if [ -z "$UBT_API_KEY" ]; then
    echo "Error: UBT_API_KEY is required for this command." >&2
    echo "Get yours at ubtrippin.xyz/settings and set UBT_API_KEY in ~/.ubt/config" >&2
    exit 1
  fi
}

_api() {
  _require_api_key
  curl -s "$@" \
    -H "Authorization: Bearer ${UBT_API_KEY}" \
    -H "Content-Type: application/json"
}

_api_with_status() {
  _require_api_key
  curl -s -w "\n%{http_code}" "$@" \
    -H "Authorization: Bearer ${UBT_API_KEY}" \
    -H "Content-Type: application/json"
}

_confirm_delete() {
  local label="$1"
  local confirm
  read -r -p "Delete ${label}? [y/N]: " confirm
  case "${confirm}" in
    y|Y|yes|YES) return 0 ;;
    *) return 1 ;;
  esac
}

_json() {
  if command -v python3 &>/dev/null; then
    python3 -m json.tool 2>/dev/null || cat
  else
    cat
  fi
}

_format_trips() {
  python3 -c "
import json, sys
data = json.load(sys.stdin)
if not data:
    print('No trips found.')
    sys.exit(0)
for t in data:
    dates = ''
    if t.get('start_date'):
        dates = t['start_date']
        if t.get('end_date') and t['end_date'] != t['start_date']:
            dates += ' → ' + t['end_date']
    loc = t.get('primary_location') or ''
    print(f\"  {t['id'][:8]}  {t.get('title','(unnamed)'):<30} {dates:<25} {loc}\")
"
}

_format_items() {
  python3 -c "
import json, sys
data = json.load(sys.stdin)
if not data:
    print('No items found.')
    sys.exit(0)
for item in data:
    det = item.get('details_json') or {}
    kind = item.get('kind','?').upper()
    provider = item.get('provider','')
    summary = item.get('summary','')
    dep_time = det.get('departure_local_time','')
    arr_time = det.get('arrival_local_time','')
    start_loc = item.get('start_location','')
    end_loc = item.get('end_location','')
    date = item.get('start_date','')
    
    time_str = ''
    if dep_time:
        time_str = dep_time
        if arr_time:
            time_str += ' → ' + arr_time
    
    loc_str = start_loc
    if end_loc and end_loc != start_loc:
        loc_str += ' → ' + end_loc
    
    print(f\"  {item['id'][:8]}  {kind:<10} {provider:<20} {date}  {time_str:<15} {loc_str}\")
    if summary:
        print(f\"           {summary}\")
"
}

# Commands
cmd_trips_list() {
  local user_id="${1:-}"
  local query="select=id,title,start_date,end_date,primary_location,travelers&order=start_date.desc.nullslast&limit=20"
  if [ -n "$user_id" ]; then
    query="${query}&user_id=eq.${user_id}"
  fi
  
  local result=$(_curl "${API}/trips?${query}")
  
  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
  else
    echo "Trips:"
    echo "$result" | _format_trips
  fi
}

cmd_trips_show() {
  local trip_id="$1"
  
  # Get trip
  local trip=$(_curl "${API}/trips?id=eq.${trip_id}&select=*")
  
  # Also try partial match
  if [ "$(echo "$trip" | python3 -c 'import json,sys;print(len(json.load(sys.stdin)))' 2>/dev/null)" = "0" ]; then
    trip=$(_curl "${API}/trips?id=like.${trip_id}*&select=*")
  fi
  
  # Get items
  local items=$(_curl "${API}/trip_items?trip_id=eq.${trip_id}&select=*&order=start_date,start_ts")
  
  if [ "${FORMAT:-pretty}" = "json" ]; then
    python3 -c "
import json, sys
trip = json.loads('''${trip}''')
items = json.loads('''${items}''')
print(json.dumps({'trip': trip[0] if trip else None, 'items': items}, indent=2))
"
  else
    echo "$trip" | python3 -c "
import json, sys
data = json.load(sys.stdin)
if not data:
    print('Trip not found.')
    sys.exit(1)
t = data[0]
print(f\"Trip: {t.get('title','(unnamed)')}\")
print(f\"  ID: {t['id']}\")
dates = t.get('start_date','')
if t.get('end_date'): dates += ' → ' + t['end_date']
print(f\"  Dates: {dates}\")
if t.get('primary_location'): print(f\"  Location: {t['primary_location']}\")
if t.get('travelers'): print(f\"  Travelers: {', '.join(t['travelers'])}\")
print()
"
    echo "Items:"
    echo "$items" | _format_items
  fi
}

cmd_items_list() {
  local trip_id="$1"
  local items=$(_curl "${API}/trip_items?trip_id=eq.${trip_id}&select=*&order=start_date,start_ts")
  
  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$items" | _json
  else
    echo "$items" | _format_items
  fi
}

cmd_tables() {
  # List all tables via RPC or information_schema
  _curl "${API}/rpc/get_tables" -X POST -d '{}' 2>/dev/null | _json || \
  echo "Use 'supabase db' commands for schema inspection."
}

cmd_sql() {
  local query="$1"
  _curl "${SUPABASE_URL}/rest/v1/rpc/exec_sql" -X POST -d "{\"query\": \"$query\"}" | _json
}

cmd_health() {
  curl -s "${SUPABASE_URL}/rest/v1/" \
    -H "apikey: ${SUPABASE_KEY}" \
    -o /dev/null -w "Supabase: HTTP %{http_code} (%{time_total}s)\n"
  
  curl -s "https://www.ubtrippin.xyz/api/health" \
    -o /dev/null -w "App: HTTP %{http_code} (%{time_total}s)\n"
}

cmd_users() {
  _curl "${API}/profiles?select=id,email,full_name,created_at&order=created_at" | python3 -c "
import json, sys
data = json.load(sys.stdin)
if isinstance(data, dict) and 'message' in data:
    print(f'Error: {data[\"message\"]}')
    sys.exit(1)
for u in data:
    email = u.get('email','?')
    name = u.get('full_name','')
    created = (u.get('created_at') or '?')[:10]
    print(f\"  {u['id'][:8]}  {email:<35} {name:<20} joined: {created}\")
" 2>/dev/null || echo "Could not list users"
}

cmd_trips_merge() {
  local target_id="${1:?Usage: ubt trips merge <target_trip_id> <source_trip_id>}"
  local source_id="${2:?Usage: ubt trips merge <target_trip_id> <source_trip_id>}"
  echo "Merging source trip ${source_id:0:8} → target ${target_id:0:8}..."
  _api -X POST "${API_V1}/trips/${target_id}/merge" \
    -d "{\"source_trip_id\": \"${source_id}\"}" | _json
}

cmd_items_move() {
  local item_id="${1:?Usage: ubt items move <item_id> <target_trip_id>}"
  local trip_id="${2:?Usage: ubt items move <item_id> <target_trip_id>}"
  echo "Moving item ${item_id:0:8} → trip ${trip_id:0:8}..."
  _api -X PATCH "${API_V1}/items/${item_id}" \
    -d "{\"trip_id\": \"${trip_id}\"}" | _json
}

cmd_trips_create() {
  local title="${1:?Usage: ubt trips create <title> [--start YYYY-MM-DD] [--end YYYY-MM-DD]}"
  shift

  local start_date=""
  local end_date=""
  while [ "$#" -gt 0 ]; do
    case "$1" in
      --start)
        start_date="${2:-}"
        if [ -z "$start_date" ]; then
          echo "Error: --start requires YYYY-MM-DD" >&2
          exit 1
        fi
        shift 2
        ;;
      --end)
        end_date="${2:-}"
        if [ -z "$end_date" ]; then
          echo "Error: --end requires YYYY-MM-DD" >&2
          exit 1
        fi
        shift 2
        ;;
      *)
        echo "Unknown option: $1" >&2
        echo "Usage: ubt trips create <title> [--start YYYY-MM-DD] [--end YYYY-MM-DD]" >&2
        exit 1
        ;;
    esac
  done

  local body
  body=$(python3 -c "
import json, sys
title, start_date, end_date = sys.argv[1:]
payload = {'title': title}
if start_date.strip():
    payload['start_date'] = start_date.strip()
if end_date.strip():
    payload['end_date'] = end_date.strip()
print(json.dumps(payload))
" "$title" "$start_date" "$end_date")

  local result
  result=$(_api -X POST "${API_V1}/trips" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
t = payload.get('data', {})
print('Trip created:')
print(f\"  id:    {t.get('id')}\")
print(f\"  title: {t.get('title')}\")
dates = t.get('start_date') or ''
if t.get('end_date') and t.get('end_date') != t.get('start_date'):
    dates = f\"{dates} → {t.get('end_date')}\"
if dates:
    print(f\"  dates: {dates}\")
"
}

cmd_trips_update() {
  local trip_id="${1:?Usage: ubt trips update <trip_id> [--title X] [--notes X] [--start X] [--end X]}"
  shift

  local title=""
  local notes=""
  local start_date=""
  local end_date=""
  local has_title=false
  local has_notes=false
  local has_start=false
  local has_end=false

  while [ "$#" -gt 0 ]; do
    case "$1" in
      --title)
        title="${2:-}"
        has_title=true
        shift 2
        ;;
      --notes)
        notes="${2:-}"
        has_notes=true
        shift 2
        ;;
      --start)
        start_date="${2:-}"
        has_start=true
        shift 2
        ;;
      --end)
        end_date="${2:-}"
        has_end=true
        shift 2
        ;;
      *)
        echo "Unknown option: $1" >&2
        echo "Usage: ubt trips update <trip_id> [--title X] [--notes X] [--start X] [--end X]" >&2
        exit 1
        ;;
    esac
  done

  if [ "$has_title" = false ] && [ "$has_notes" = false ] && [ "$has_start" = false ] && [ "$has_end" = false ]; then
    echo "Error: provide at least one field to update." >&2
    exit 1
  fi

  local body
  body=$(python3 -c "
import json, sys
title, notes, start_date, end_date, has_title, has_notes, has_start, has_end = sys.argv[1:]
payload = {}
if has_title == 'true':
    payload['title'] = title
if has_notes == 'true':
    payload['notes'] = notes
if has_start == 'true':
    payload['start_date'] = start_date
if has_end == 'true':
    payload['end_date'] = end_date
print(json.dumps(payload))
" "$title" "$notes" "$start_date" "$end_date" "$has_title" "$has_notes" "$has_start" "$has_end")

  local result
  result=$(_api -X PATCH "${API_V1}/trips/${trip_id}" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
t = payload.get('data', {})
print('Trip updated:')
print(f\"  id:    {t.get('id')}\")
print(f\"  title: {t.get('title')}\")
"
}

cmd_trips_rename() {
  local trip_id="${1:?Usage: ubt trips rename <trip_id> <new_title>}"
  shift
  local new_title="$*"
  if [ -z "$new_title" ]; then
    echo "Usage: ubt trips rename <trip_id> <new_title>" >&2
    exit 1
  fi

  local body
  body=$(python3 -c "import json,sys; print(json.dumps({'title': sys.argv[1]}))" "$new_title")

  local result
  result=$(_api -X POST "${API_V1}/trips/${trip_id}/rename" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
d = payload.get('data', {})
print('Trip rename result:')
print(f\"  title:   {d.get('title')}\")
print(f\"  renamed: {d.get('renamed')}\")
"
}

cmd_trips_delete() {
  local trip_id="${1:?Usage: ubt trips delete <trip_id>}"
  if ! _confirm_delete "trip ${trip_id}"; then
    echo "Canceled."
    return
  fi

  local response http_code body
  response=$(_api_with_status -X DELETE "${API_V1}/trips/${trip_id}")
  http_code=$(echo "$response" | tail -1)
  body=$(echo "$response" | sed '$d')

  if [ "$http_code" = "204" ] || [ "$http_code" = "200" ]; then
    if [ "${FORMAT:-pretty}" = "json" ]; then
      if [ -n "$body" ]; then
        echo "$body" | _json
      else
        echo "{}"
      fi
    else
      echo "Deleted trip ${trip_id:0:8}."
    fi
    return
  fi

  if [ "${FORMAT:-pretty}" = "json" ]; then
    if [ -n "$body" ]; then
      echo "$body" | _json
    else
      echo "{\"error\":{\"message\":\"Request failed (HTTP ${http_code})\"}}"
    fi
  else
    if [ -n "$body" ]; then
      echo "$body" | python3 -c "
import json, sys
try:
    payload = json.load(sys.stdin)
except Exception:
    print('Failed to delete trip.')
    sys.exit(0)
if 'error' in payload:
    print(f\"Error: {payload['error'].get('message', 'Failed to delete trip.')}\")
else:
    print('Failed to delete trip.')
"
    else
      echo "Failed (HTTP ${http_code})"
    fi
  fi
  exit 1
}

cmd_trips_status() {
  local trip_id="${1:?Usage: ubt trips status <trip_id>}"
  local result
  result=$(_api "${API_V1}/trips/${trip_id}/status")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
rows = payload.get('data', [])
print(f'Trip status ({len(rows)} items):')
if not rows:
    sys.exit(0)
for r in rows:
    item_id = (r.get('item_id') or '')[:8]
    kind = r.get('kind') or '?'
    status = r.get('status') or 'unknown'
    delay = r.get('delay_minutes')
    delay_str = f\" delay:{delay}m\" if delay is not None else ''
    ident = r.get('flight_number') or r.get('train_number') or '-'
    checked = (r.get('last_checked_at') or '')[:19]
    print(f\"  {item_id:<8} {kind:<8} {ident:<12} {status}{delay_str}\")
    if checked:
        print(f\"           last_checked: {checked}\")
"
}

cmd_items_show() {
  local item_id="${1:?Usage: ubt items show <item_id>}"
  local result
  result=$(_api "${API_V1}/items/${item_id}")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
i = payload.get('data', {})
print('Item:')
print(f\"  id:       {i.get('id')}\")
print(f\"  trip_id:  {i.get('trip_id')}\")
print(f\"  kind:     {i.get('kind')}\")
print(f\"  provider: {i.get('provider') or '-'}\")
print(f\"  summary:  {i.get('summary') or '-'}\")
print(f\"  date:     {i.get('start_date') or '-'}\")
if i.get('start_location') or i.get('end_location'):
    print(f\"  route:    {(i.get('start_location') or '-') } → {(i.get('end_location') or '-')}\")
"
}

cmd_items_add() {
  local trip_id="${1:?Usage: ubt items add <trip_id> --kind <kind> --summary <text> [--provider X] [--start-ts X] [--end-ts X] [--start-location X] [--end-location X] [--details-json '{...}']}"
  shift

  local kind=""
  local summary=""
  local provider=""
  local start_ts=""
  local end_ts=""
  local start_location=""
  local end_location=""
  local details_json=""

  while [ "$#" -gt 0 ]; do
    case "$1" in
      --kind)
        kind="${2:-}"
        shift 2
        ;;
      --summary)
        summary="${2:-}"
        shift 2
        ;;
      --provider)
        provider="${2:-}"
        shift 2
        ;;
      --start-ts)
        start_ts="${2:-}"
        shift 2
        ;;
      --end-ts)
        end_ts="${2:-}"
        shift 2
        ;;
      --start-location)
        start_location="${2:-}"
        shift 2
        ;;
      --end-location)
        end_location="${2:-}"
        shift 2
        ;;
      --details-json)
        details_json="${2:-}"
        shift 2
        ;;
      *)
        echo "Unknown option: $1" >&2
        echo "Usage: ubt items add <trip_id> --kind <kind> --summary <text> [--provider X] [--start-ts X] [--end-ts X] [--start-location X] [--end-location X] [--details-json '{...}']" >&2
        exit 1
        ;;
    esac
  done

  if [ -z "$kind" ] || [ -z "$summary" ]; then
    echo "Error: --kind and --summary are required." >&2
    exit 1
  fi

  local body
  body=$(python3 -c "
import json, sys
kind, summary, provider, start_ts, end_ts, start_location, end_location, details_json = sys.argv[1:]
payload = {'kind': kind, 'summary': summary}
if provider.strip():
    payload['provider'] = provider.strip()
if start_ts.strip():
    payload['start_ts'] = start_ts.strip()
    payload['start_date'] = start_ts.strip()[:10]
if end_ts.strip():
    payload['end_ts'] = end_ts.strip()
    payload['end_date'] = end_ts.strip()[:10]
if start_location.strip():
    payload['start_location'] = start_location.strip()
if end_location.strip():
    payload['end_location'] = end_location.strip()
if details_json.strip():
    try:
        payload['details_json'] = json.loads(details_json)
    except Exception:
        print('__ERR__')
        sys.exit(0)
print(json.dumps(payload))
" "$kind" "$summary" "$provider" "$start_ts" "$end_ts" "$start_location" "$end_location" "$details_json")

  if [ "$body" = "__ERR__" ]; then
    echo "Error: --details-json must be valid JSON." >&2
    exit 1
  fi

  local result
  result=$(_api -X POST "${API_V1}/trips/${trip_id}/items" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
i = payload.get('data', {})
print('Item created:')
print(f\"  id:      {i.get('id')}\")
print(f\"  trip_id: {i.get('trip_id')}\")
print(f\"  kind:    {i.get('kind')}\")
print(f\"  summary: {i.get('summary')}\")
"
}

cmd_items_update() {
  local item_id="${1:?Usage: ubt items update <item_id> [--summary X] [--start-location X] [--end-location X] [--status X]}"
  shift

  local summary=""
  local start_location=""
  local end_location=""
  local status=""
  local has_summary=false
  local has_start_location=false
  local has_end_location=false
  local has_status=false

  while [ "$#" -gt 0 ]; do
    case "$1" in
      --summary)
        summary="${2:-}"
        has_summary=true
        shift 2
        ;;
      --start-location)
        start_location="${2:-}"
        has_start_location=true
        shift 2
        ;;
      --end-location)
        end_location="${2:-}"
        has_end_location=true
        shift 2
        ;;
      --status)
        status="${2:-}"
        has_status=true
        shift 2
        ;;
      *)
        echo "Unknown option: $1" >&2
        echo "Usage: ubt items update <item_id> [--summary X] [--start-location X] [--end-location X] [--status X]" >&2
        exit 1
        ;;
    esac
  done

  if [ "$has_summary" = false ] && [ "$has_start_location" = false ] && [ "$has_end_location" = false ] && [ "$has_status" = false ]; then
    echo "Error: provide at least one field to update." >&2
    exit 1
  fi

  local body
  body=$(python3 -c "
import json, sys
summary, start_location, end_location, status, has_summary, has_start, has_end, has_status = sys.argv[1:]
payload = {}
if has_summary == 'true':
    payload['summary'] = summary
if has_start == 'true':
    payload['start_location'] = start_location
if has_end == 'true':
    payload['end_location'] = end_location
if has_status == 'true':
    payload['status'] = status
print(json.dumps(payload))
" "$summary" "$start_location" "$end_location" "$status" "$has_summary" "$has_start_location" "$has_end_location" "$has_status")

  local result
  result=$(_api -X PATCH "${API_V1}/items/${item_id}" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
i = payload.get('data', {})
print('Item updated:')
print(f\"  id:      {i.get('id')}\")
print(f\"  summary: {i.get('summary') or '-'}\")
print(f\"  status:  {i.get('status') or '-'}\")
"
}

cmd_items_delete() {
  local item_id="${1:?Usage: ubt items delete <item_id>}"
  if ! _confirm_delete "item ${item_id}"; then
    echo "Canceled."
    return
  fi

  local response http_code body
  response=$(_api_with_status -X DELETE "${API_V1}/items/${item_id}")
  http_code=$(echo "$response" | tail -1)
  body=$(echo "$response" | sed '$d')

  if [ "$http_code" = "204" ] || [ "$http_code" = "200" ]; then
    if [ "${FORMAT:-pretty}" = "json" ]; then
      if [ -n "$body" ]; then
        echo "$body" | _json
      else
        echo "{}"
      fi
    else
      echo "Deleted item ${item_id:0:8}."
    fi
    return
  fi

  if [ "${FORMAT:-pretty}" = "json" ]; then
    if [ -n "$body" ]; then
      echo "$body" | _json
    else
      echo "{\"error\":{\"message\":\"Request failed (HTTP ${http_code})\"}}"
    fi
  else
    if [ -n "$body" ]; then
      echo "$body" | python3 -c "
import json, sys
try:
    payload = json.load(sys.stdin)
except Exception:
    print('Failed to delete item.')
    sys.exit(0)
if 'error' in payload:
    print(f\"Error: {payload['error'].get('message', 'Failed to delete item.')}\")
else:
    print('Failed to delete item.')
"
    else
      echo "Failed (HTTP ${http_code})"
    fi
  fi
  exit 1
}

cmd_items_status() {
  local item_id="${1:?Usage: ubt items status <item_id>}"
  local result
  result=$(_api "${API_V1}/items/${item_id}/status")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
d = payload.get('data', {})
item = d.get('item') or {}
status = d.get('status') or {}
print('Item status:')
print(f\"  item_id:      {item.get('id')}\")
print(f\"  kind:         {item.get('kind')}\")
print(f\"  status:       {status.get('status')}\")
print(f\"  delay_minutes:{status.get('delay_minutes')}\")
print(f\"  source:       {status.get('source')}\")
last_checked = status.get('last_checked_at')
if last_checked:
    print(f\"  last_checked: {last_checked}\")
"
}

cmd_items_refresh() {
  local item_id="${1:?Usage: ubt items refresh <item_id>}"
  local result
  result=$(_api -X POST "${API_V1}/items/${item_id}/status/refresh")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
d = payload.get('data', {})
status = d.get('status') or {}
meta = payload.get('meta') or {}
print('Item status refreshed:')
print(f\"  status:       {status.get('status')}\")
print(f\"  delay_minutes:{status.get('delay_minutes')}\")
print(f\"  source:       {status.get('source')}\")
if meta:
    if meta.get('subscription_tier'):
        print(f\"  tier:         {meta.get('subscription_tier')}\")
    if meta.get('remaining_today') is not None:
        print(f\"  remaining:    {meta.get('remaining_today')}\")
"
}

cmd_guides_list() {
  local result
  result=$(_api "${API_V1}/guides")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
guides = payload.get('data', [])
print(f'Guides ({len(guides)}):')
if not guides:
    sys.exit(0)
for g in guides:
    country = g.get('country') or g.get('country_code') or ''
    place = g.get('city', '?')
    if country:
        place += ', ' + country
    print(f\"  {g.get('id','')[:8]}  {place:<28} updated:{(g.get('updated_at') or '')[:10]}\")
"
}

cmd_guides_create() {
  local city="${1:?Usage: ubt guides create <city> [--country X] [--country-code XX]}"
  shift

  local country=""
  local country_code=""
  while [ "$#" -gt 0 ]; do
    case "$1" in
      --country)
        country="${2:-}"
        shift 2
        ;;
      --country-code)
        country_code="${2:-}"
        shift 2
        ;;
      *)
        echo "Unknown option: $1" >&2
        echo "Usage: ubt guides create <city> [--country X] [--country-code XX]" >&2
        exit 1
        ;;
    esac
  done

  local body
  body=$(python3 -c "
import json, sys
city, country, code = sys.argv[1:]
payload = {'city': city}
if country.strip():
    payload['country'] = country.strip()
if code.strip():
    payload['country_code'] = code.strip()
print(json.dumps(payload))
" "$city" "$country" "$country_code")

  local result
  result=$(_api -X POST "${API_V1}/guides" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
g = payload.get('data', {})
country = g.get('country') or g.get('country_code') or ''
place = g.get('city', '?')
if country:
    place += ', ' + country
print('Guide created:')
print(f\"  id:   {g.get('id')}\")
print(f\"  city: {place}\")
"
}

cmd_guides_show() {
  local guide_id="${1:?Usage: ubt guides show <guide_id>}"
  local result
  result=$(_api "${API_V1}/guides/${guide_id}")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
g = payload.get('data', {})
entries = g.get('entries', [])
country = g.get('country') or g.get('country_code') or ''
place = g.get('city', '?')
if country:
    place += ', ' + country
print('Guide:')
print(f\"  id:    {g.get('id')}\")
print(f\"  city:  {place}\")
print(f\"  items: {len(entries)}\")
if not entries:
    sys.exit(0)
print()
print('Entries:')
for e in entries:
    status = e.get('status') or '-'
    category = e.get('category') or '-'
    print(f\"  {e.get('id','')[:8]}  {e.get('name','?'):<28} {category:<16} {status}\")
"
}

cmd_guides_delete() {
  local guide_id="${1:?Usage: ubt guides delete <guide_id>}"
  if ! _confirm_delete "guide ${guide_id}"; then
    echo "Canceled."
    return
  fi

  local response http_code body
  response=$(_api_with_status -X DELETE "${API_V1}/guides/${guide_id}")
  http_code=$(echo "$response" | tail -1)
  body=$(echo "$response" | sed '$d')

  if [ "$http_code" = "204" ] || [ "$http_code" = "200" ]; then
    if [ "${FORMAT:-pretty}" = "json" ]; then
      if [ -n "$body" ]; then
        echo "$body" | _json
      else
        echo "{}"
      fi
    else
      echo "Deleted guide ${guide_id:0:8}."
    fi
    return
  fi

  if [ "${FORMAT:-pretty}" = "json" ]; then
    if [ -n "$body" ]; then
      echo "$body" | _json
    else
      echo "{\"error\":{\"message\":\"Request failed (HTTP ${http_code})\"}}"
    fi
  else
    if [ -n "$body" ]; then
      echo "$body" | python3 -c "
import json, sys
try:
    payload = json.load(sys.stdin)
except Exception:
    print('Failed to delete guide.')
    sys.exit(0)
if 'error' in payload:
    print(f\"Error: {payload['error'].get('message', 'Failed to delete guide.')}\")
else:
    print('Failed to delete guide.')
"
    else
      echo "Failed (HTTP ${http_code})"
    fi
  fi
  exit 1
}

cmd_guides_entry_add() {
  local guide_id="${1:?Usage: ubt guides entry add <guide_id> --name <name> --category <cat> [--description X] [--url X] [--tags tag1,tag2] [--status visited|to_try]}"
  shift

  local name=""
  local category=""
  local description=""
  local website_url=""
  local tags_csv=""
  local status="visited"

  while [ "$#" -gt 0 ]; do
    case "$1" in
      --name)
        name="${2:-}"
        shift 2
        ;;
      --category)
        category="${2:-}"
        shift 2
        ;;
      --description)
        description="${2:-}"
        shift 2
        ;;
      --url)
        website_url="${2:-}"
        shift 2
        ;;
      --tags)
        tags_csv="${2:-}"
        shift 2
        ;;
      --status)
        status="${2:-}"
        shift 2
        ;;
      *)
        echo "Unknown option: $1" >&2
        echo "Usage: ubt guides entry add <guide_id> --name <name> --category <cat> [--description X] [--url X] [--tags tag1,tag2] [--status visited|to_try]" >&2
        exit 1
        ;;
    esac
  done

  if [ -z "$name" ] || [ -z "$category" ]; then
    echo "Error: --name and --category are required." >&2
    exit 1
  fi
  if [ "$status" != "visited" ] && [ "$status" != "to_try" ]; then
    echo "Error: --status must be 'visited' or 'to_try'." >&2
    exit 1
  fi

  local body
  body=$(python3 -c "
import json, sys
name, category, description, website_url, tags_csv, status = sys.argv[1:]
payload = {'name': name, 'category': category, 'status': status}
if description.strip():
    payload['description'] = description.strip()
if website_url.strip():
    payload['website_url'] = website_url.strip()
if tags_csv.strip():
    payload['tags'] = [t.strip() for t in tags_csv.split(',') if t.strip()]
print(json.dumps(payload))
" "$name" "$category" "$description" "$website_url" "$tags_csv" "$status")

  local result
  result=$(_api -X POST "${API_V1}/guides/${guide_id}/entries" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
e = payload.get('data', {})
print('Guide entry created:')
print(f\"  id:       {e.get('id')}\")
print(f\"  name:     {e.get('name')}\")
print(f\"  category: {e.get('category')}\")
print(f\"  status:   {e.get('status')}\")
"
}

cmd_guides_entry_update() {
  local guide_id="${1:?Usage: ubt guides entry update <guide_id> <entry_id> [--name X] [--category X] [--description X]}"
  local entry_id="${2:?Usage: ubt guides entry update <guide_id> <entry_id> [--name X] [--category X] [--description X]}"
  shift 2

  local name=""
  local category=""
  local description=""
  local has_name=false
  local has_category=false
  local has_description=false

  while [ "$#" -gt 0 ]; do
    case "$1" in
      --name)
        name="${2:-}"
        has_name=true
        shift 2
        ;;
      --category)
        category="${2:-}"
        has_category=true
        shift 2
        ;;
      --description)
        description="${2:-}"
        has_description=true
        shift 2
        ;;
      *)
        echo "Unknown option: $1" >&2
        echo "Usage: ubt guides entry update <guide_id> <entry_id> [--name X] [--category X] [--description X]" >&2
        exit 1
        ;;
    esac
  done

  if [ "$has_name" = false ] && [ "$has_category" = false ] && [ "$has_description" = false ]; then
    echo "Error: provide at least one field to update." >&2
    exit 1
  fi

  local body
  body=$(python3 -c "
import json, sys
name, category, description, has_name, has_category, has_description = sys.argv[1:]
payload = {}
if has_name == 'true':
    payload['name'] = name
if has_category == 'true':
    payload['category'] = category
if has_description == 'true':
    payload['description'] = description
print(json.dumps(payload))
" "$name" "$category" "$description" "$has_name" "$has_category" "$has_description")

  local result
  result=$(_api -X PATCH "${API_V1}/guides/${guide_id}/entries/${entry_id}" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
e = payload.get('data', {})
print('Guide entry updated:')
print(f\"  id:       {e.get('id')}\")
print(f\"  name:     {e.get('name')}\")
print(f\"  category: {e.get('category')}\")
"
}

cmd_guides_entry_delete() {
  local guide_id="${1:?Usage: ubt guides entry delete <guide_id> <entry_id>}"
  local entry_id="${2:?Usage: ubt guides entry delete <guide_id> <entry_id>}"
  if ! _confirm_delete "guide entry ${entry_id}"; then
    echo "Canceled."
    return
  fi

  local response http_code body
  response=$(_api_with_status -X DELETE "${API_V1}/guides/${guide_id}/entries/${entry_id}")
  http_code=$(echo "$response" | tail -1)
  body=$(echo "$response" | sed '$d')

  if [ "$http_code" = "204" ] || [ "$http_code" = "200" ]; then
    if [ "${FORMAT:-pretty}" = "json" ]; then
      if [ -n "$body" ]; then
        echo "$body" | _json
      else
        echo "{}"
      fi
    else
      echo "Deleted guide entry ${entry_id:0:8}."
    fi
    return
  fi

  if [ "${FORMAT:-pretty}" = "json" ]; then
    if [ -n "$body" ]; then
      echo "$body" | _json
    else
      echo "{\"error\":{\"message\":\"Request failed (HTTP ${http_code})\"}}"
    fi
  else
    if [ -n "$body" ]; then
      echo "$body" | python3 -c "
import json, sys
try:
    payload = json.load(sys.stdin)
except Exception:
    print('Failed to delete guide entry.')
    sys.exit(0)
if 'error' in payload:
    print(f\"Error: {payload['error'].get('message', 'Failed to delete guide entry.')}\")
else:
    print('Failed to delete guide entry.')
"
    else
      echo "Failed (HTTP ${http_code})"
    fi
  fi
  exit 1
}

cmd_guides_nearby() {
  local lat=""
  local lng=""
  local radius=""

  while [ "$#" -gt 0 ]; do
    case "$1" in
      --lat)
        lat="${2:-}"
        shift 2
        ;;
      --lng)
        lng="${2:-}"
        shift 2
        ;;
      --radius)
        radius="${2:-}"
        shift 2
        ;;
      *)
        echo "Unknown option: $1" >&2
        echo "Usage: ubt guides nearby --lat X --lng Y [--radius KM]" >&2
        exit 1
        ;;
    esac
  done

  if [ -z "$lat" ] || [ -z "$lng" ]; then
    echo "Usage: ubt guides nearby --lat X --lng Y [--radius KM]" >&2
    exit 1
  fi

  local query
  query="lat=${lat}&lng=${lng}"
  if [ -n "$radius" ]; then
    query="${query}&radius=${radius}"
  fi

  local result
  result=$(_api "${API_V1}/guides/nearby?${query}")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
rows = payload.get('data', [])
meta = payload.get('meta', {})
print(f\"Nearby guide entries ({len(rows)}), radius: {meta.get('radius_km', '?')}km\")
if not rows:
    sys.exit(0)
for row in rows:
    dist = row.get('distance_m')
    dist_str = f\"{dist/1000:.2f}km\" if isinstance(dist, (int, float)) else '?'
    city_guide = row.get('city_guides') or {}
    city = city_guide.get('city') or ''
    country = city_guide.get('country') or city_guide.get('country_code') or ''
    place = city if not country else f\"{city}, {country}\"
    print(f\"  {row.get('id','')[:8]}  {row.get('name','?'):<28} {row.get('category','?'):<16} {dist_str}\")
    if place:
        print(f\"           {place}\")
"
}

cmd_trains_status() {
  local train_number="${1:?Usage: ubt trains status <train_number> [--date YYYY-MM-DD]}"
  shift || true

  local date
  date="$(date -u +%Y-%m-%d)"

  while [ "$#" -gt 0 ]; do
    case "$1" in
      --date)
        date="${2:-}"
        shift 2
        ;;
      *)
        echo "Unknown option: $1" >&2
        echo "Usage: ubt trains status <train_number> [--date YYYY-MM-DD]" >&2
        exit 1
        ;;
    esac
  done

  local result
  result=$(_api "${API_V1}/trains/${train_number}/status?date=${date}")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if isinstance(payload, dict) and 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
print('Train status:')
print(f\"  train:      {payload.get('train_number')}\")
print(f\"  date:       {payload.get('date')}\")
print(f\"  status:     {payload.get('status')}\")
print(f\"  delay:      {payload.get('delay_minutes')}\")
print(f\"  platform:   {payload.get('platform')}\")
print(f\"  departure:  {payload.get('departure_station')}\")
print(f\"  arrival:    {payload.get('arrival_station')}\")
print(f\"  source:     {payload.get('source')}\")
"
}

cmd_billing_show() {
  local result
  result=$(_api "${API_V1}/billing/subscription")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
print('Billing:')
print(f\"  tier:           {payload.get('subscription_tier')}\")
print(f\"  period_end:     {payload.get('subscription_current_period_end')}\")
print(f\"  grace_until:    {payload.get('subscription_grace_until')}\")
spots = payload.get('earlyAdopterSpotsRemaining')
if spots is not None:
    print(f\"  early_spots:    {spots}\")
price = payload.get('current_price') or {}
if price:
    amount = price.get('amount')
    currency = (price.get('currency') or '').upper()
    interval = price.get('interval') or ''
    print(f\"  current_price:  {amount} {currency} / {interval}\")
"
}

cmd_billing_portal() {
  local result
  result=$(_api "${API_V1}/billing/portal")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
url = payload.get('url')
if not url:
    print('Error: portal URL missing.')
    sys.exit(1)
print('Billing portal URL:')
print(url)
"
}

cmd_activation_status() {
  local result
  result=$(_api "${API_V1}/activation/status")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
print('Activation status:')
print(f\"  activated:       {payload.get('activated')}\")
print(f\"  first_forward:   {payload.get('first_forward_at')}\")
print(f\"  second_trip:     {payload.get('second_trip_at')}\")
print(f\"  activated_at:    {payload.get('activated_at')}\")
print(f\"  nudge_1_sent_at: {payload.get('nudge_1_sent_at')}\")
print(f\"  nudge_2_sent_at: {payload.get('nudge_2_sent_at')}\")
print(f\"  nudge_3_sent_at: {payload.get('nudge_3_sent_at')}\")
"
}

cmd_calendar_get() {
  _api "${API_V1}/calendar/token" | python3 -c "
import json, sys
data = json.load(sys.stdin)
d = data.get('data', {})
if not d:
    print(json.dumps(data, indent=2))
    sys.exit(0)
print('Calendar feed URL:')
print(f\"  {d.get('feed_url', 'N/A')}\")
print()
print('Add this URL to any calendar app (Google Calendar, Apple, Fantastical).')
print('Token: ' + d.get('token', 'N/A')[:8] + '...')
"
}

cmd_calendar_regen() {
  echo "Regenerating calendar token (this will invalidate the old URL)..."
  _api -X POST "${API_V1}/calendar/token" | python3 -c "
import json, sys
data = json.load(sys.stdin)
d = data.get('data', {})
print('New calendar feed URL:')
print(f\"  {d.get('feed_url', 'N/A')}\")
"
}

cmd_senders_list() {
  _api "${API_V1}/settings/senders" | python3 -c "
import json, sys
data = json.load(sys.stdin)
senders = data.get('data', [])
if not senders:
    print('No senders configured.')
    sys.exit(0)
print(f'Allowed senders ({len(senders)}):')
for s in senders:
    label = s.get('label') or ''
    label_str = f' [{label}]' if label else ''
    verified = ' ✓' if s.get('verified') else ''
    print(f\"  {s['id'][:8]}  {s['email']:<35}{label_str}{verified}\")
"
}

cmd_senders_add() {
  local email="${1:?Usage: ubt senders add <email> [label]}"
  local label="${2:-}"
  local body
  if [ -n "$label" ]; then
    body="{\"email\": \"${email}\", \"label\": \"${label}\"}"
  else
    body="{\"email\": \"${email}\"}"
  fi
  _api -X POST "${API_V1}/settings/senders" -d "$body" | python3 -c "
import json, sys
data = json.load(sys.stdin)
if 'error' in data:
    print(f'Error: {data[\"error\"][\"message\"]}')
    sys.exit(1)
d = data.get('data', {})
print(f'Added: {d.get(\"email\")} (id: {d.get(\"id\", \"\")[:8]}...)')
"
}

cmd_senders_remove() {
  local sender_id="${1:?Usage: ubt senders remove <sender_id>}"
  echo "Removing sender ${sender_id:0:8}..."
  local status
  status=$(curl -s -o /dev/null -w "%{http_code}" \
    -X DELETE "${API_V1}/settings/senders/${sender_id}" \
    -H "Authorization: Bearer ${UBT_API_KEY}" \
    -H "Content-Type: application/json")
  if [ "$status" = "204" ]; then
    echo "Removed."
  else
    echo "Failed (HTTP ${status})"
    exit 1
  fi
}

cmd_webhooks_list() {
  local result
  result=$(_api "${API_V1}/webhooks")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
webhooks = payload.get('data', [])
if not webhooks:
    print('No webhooks configured.')
    sys.exit(0)
print(f'Webhooks ({len(webhooks)}):')
for w in webhooks:
    events = w.get('events') or []
    events_str = str(len(events)) if events else 'all'
    status = 'enabled' if w.get('enabled') else 'disabled'
    desc = w.get('description') or ''
    print(f\"  {w['id'][:8]}  {status:<8} events:{events_str:<4} {w.get('url','')}\")
    if desc:
        print(f\"           {desc}\")
"
}

cmd_webhooks_add() {
  local url="${1:?Usage: ubt webhooks add <url> [--events a,b,c] [--secret <s>] [--description <text>]}"
  shift

  local events=""
  local secret=""
  local description=""

  while [ "$#" -gt 0 ]; do
    case "$1" in
      --events)
        events="${2:-}"
        shift 2
        ;;
      --secret)
        secret="${2:-}"
        shift 2
        ;;
      --description)
        description="${2:-}"
        shift 2
        ;;
      *)
        echo "Unknown option: $1" >&2
        echo "Usage: ubt webhooks add <url> [--events a,b,c] [--secret <s>] [--description <text>]" >&2
        exit 1
        ;;
    esac
  done

  if [ -z "$secret" ]; then
    secret=$(python3 -c "import secrets; print(secrets.token_hex(16))")
    echo "Generated secret: $secret"
  fi

  local body
  body=$(python3 -c "
import json, sys
url, events_csv, secret, description = sys.argv[1:]
payload = {'url': url, 'secret': secret}
if events_csv.strip():
    payload['events'] = [e.strip() for e in events_csv.split(',') if e.strip()]
if description.strip():
    payload['description'] = description.strip()
print(json.dumps(payload))
" "$url" "$events" "$secret" "$description")

  local result
  result=$(_api -X POST "${API_V1}/webhooks" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
w = payload.get('data', {})
print('Webhook registered:')
print(f\"  id:  {w.get('id')}\")
print(f\"  url: {w.get('url')}\")
print(f\"  secret_masked: {w.get('secret_masked')}\")
"
}

cmd_webhooks_show() {
  local webhook_id="${1:?Usage: ubt webhooks show <id>}"
  local result
  result=$(_api "${API_V1}/webhooks/${webhook_id}")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
w = payload.get('data', {})
events = w.get('events') or []
print('Webhook:')
print(f\"  id:           {w.get('id')}\")
print(f\"  url:          {w.get('url')}\")
print(f\"  description:  {w.get('description') or '-'}\")
print(f\"  enabled:      {w.get('enabled')}\")
print(f\"  events:       {', '.join(events) if events else 'all'}\")
print(f\"  secret:       {w.get('secret_masked')}\")
print(f\"  created_at:   {w.get('created_at')}\")
print(f\"  updated_at:   {w.get('updated_at')}\")
"
}

cmd_webhooks_delete() {
  local webhook_id="${1:?Usage: ubt webhooks delete <id>}"
  echo "Deleting webhook ${webhook_id:0:8}..."
  local status
  status=$(curl -s -o /dev/null -w "%{http_code}" \
    -X DELETE "${API_V1}/webhooks/${webhook_id}" \
    -H "Authorization: Bearer ${UBT_API_KEY}" \
    -H "Content-Type: application/json")
  if [ "$status" = "204" ]; then
    echo "Deleted."
  else
    echo "Failed (HTTP ${status})"
    exit 1
  fi
}

cmd_webhooks_test() {
  local webhook_id="${1:?Usage: ubt webhooks test <id>}"
  local result
  result=$(_api -X POST "${API_V1}/webhooks/${webhook_id}/test")
  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi
  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
print('Test ping queued.')
"
}

cmd_webhooks_deliveries() {
  local webhook_id="${1:?Usage: ubt webhooks deliveries <id>}"
  local result
  result=$(_api "${API_V1}/webhooks/${webhook_id}/deliveries")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
deliveries = payload.get('data', [])
if not deliveries:
    print('No deliveries found.')
    sys.exit(0)
print(f'Deliveries ({len(deliveries)}):')
for d in deliveries:
    code = d.get('last_response_code')
    code_str = str(code) if code is not None else '-'
    created = (d.get('created_at') or '')[:19]
    print(f\"  {d.get('id','')[:8]}  {created}  {d.get('event',''):<22} {d.get('status',''):<8} code:{code_str}\")
"
}

cmd_image_search() {
  local query="${1:?Usage: ubt image search <query>}"
  _api "${API_V1}/images/search?q=$(python3 -c "import urllib.parse,sys; print(urllib.parse.quote('$query'))")" | python3 -c "
import json, sys
data = json.load(sys.stdin)
images = data.get('data', [])
if not images:
    print('No images found.')
    sys.exit(0)
print(f'Found {len(images)} images:')
for i, img in enumerate(images):
    credit = img.get('credit', {})
    by = credit.get('photographer', 'Unknown')
    print(f'  [{i+1}] {img.get(\"url\",\"\")[:60]}...')
    print(f'       thumb: {img.get(\"thumb\",\"\")[:60]}...')
    print(f'       by {by} on Unsplash')
    print()
"
}

cmd_rls_check() {
  echo "Checking RLS policies via Supabase CLI..."
  cd /home/iancr/ubtrippin
  supabase inspect db policies --linked 2>/dev/null || echo "Use 'supabase inspect db policies --linked' manually"
}

cmd_collab_list() {
  local trip_id="${1:?Usage: ubt collab list <trip_id>}"
  _api "${API_V1}/trips/${trip_id}/collaborators" | python3 -c "
import json, sys
data = json.load(sys.stdin)
if 'error' in data:
    print(f'Error: {data[\"error\"][\"message\"]}')
    sys.exit(1)
collabs = data.get('data', [])
count = data.get('meta', {}).get('count', len(collabs))
if not collabs:
    print('No collaborators on this trip.')
    sys.exit(0)
print(f'Collaborators ({count}):')
for c in collabs:
    accepted = 'accepted' if c.get('accepted_at') else 'pending'
    role = c.get('role', '?')
    email = c.get('invited_email', '?')
    cid = c.get('id', '')[:8]
    print(f'  {cid}  {email:<35} [{role}] {accepted}')
"
}

cmd_collab_invite() {
  local trip_id="${1:?Usage: ubt collab invite <trip_id> <email> [role]}"
  local email="${2:?Usage: ubt collab invite <trip_id> <email> [role]}"
  local role="${3:-editor}"
  echo "Inviting ${email} to trip ${trip_id:0:8} as ${role}..."
  _api -X POST "${API_V1}/trips/${trip_id}/collaborators" \
    -d "{\"email\": \"${email}\", \"role\": \"${role}\"}" | python3 -c "
import json, sys
data = json.load(sys.stdin)
if 'error' in data:
    print(f'Error: {data[\"error\"][\"message\"]}')
    sys.exit(1)
d = data.get('data', {})
print(f'Invited: {d.get(\"invited_email\")} as {d.get(\"role\")} (invite id: {str(d.get(\"id\",\"\"))[:8]}...)')
print('Invite email sent.')
"
}

cmd_collab_remove() {
  local trip_id="${1:?Usage: ubt collab remove <trip_id> <collaborator_id>}"
  local collab_id="${2:?Usage: ubt collab remove <trip_id> <collaborator_id>}"
  echo "Removing collaborator ${collab_id:0:8} from trip ${trip_id:0:8}..."
  local status
  status=$(curl -s -o /dev/null -w "%{http_code}" \
    -X DELETE "${API_V1}/trips/${trip_id}/collaborators/${collab_id}" \
    -H "Authorization: Bearer ${UBT_API_KEY}" \
    -H "Content-Type: application/json")
  if [ "$status" = "204" ] || [ "$status" = "200" ]; then
    echo "Removed."
  else
    echo "Failed (HTTP ${status})"
    exit 1
  fi
}

cmd_notifications_list() {
  local unread_flag="${1:-}"
  local qs=""
  if [ "$unread_flag" = "--unread" ]; then
    qs="?unread=true"
  fi
  _api "${API_V1}/notifications${qs}" | python3 -c "
import json, sys
data = json.load(sys.stdin)
if 'error' in data:
    print(f'Error: {data[\"error\"][\"message\"]}')
    sys.exit(1)
notifications = data.get('data', [])
meta = data.get('meta', {})
unread = meta.get('unread_count', 0)
if not notifications:
    print(f'No notifications. (unread: {unread})')
    sys.exit(0)
print(f'Notifications ({len(notifications)}, unread: {unread}):')
for n in notifications:
    read_status = '' if n.get('read_at') else ' [UNREAD]'
    ntype = n.get('type', '?')
    nid = n.get('id', '')[:8]
    created = (n.get('created_at') or '')[:16]
    trip_id = (n.get('trip_id') or '')[:8]
    ddata = n.get('data', {}) or {}
    detail = ddata.get('actor_name') or ddata.get('item_summary') or ''
    print(f'  {nid}  {ntype:<25} {created}  trip:{trip_id}  {detail}{read_status}')
"
}

cmd_notifications_read() {
  local notification_id="${1:?Usage: ubt notifications read <notification_id>}"
  _api -X PATCH "${API_V1}/notifications/${notification_id}" -d '{}' | python3 -c "
import json, sys
data = json.load(sys.stdin)
if 'error' in data:
    print(f'Error: {data[\"error\"][\"message\"]}')
    sys.exit(1)
d = data.get('data', {})
print(f'Marked read: {d.get(\"id\",\"?\")[:8]} (read_at: {d.get(\"read_at\",\"?\")[:19]})')
"
}

cmd_profile_show() {
  local profile_json loyalty_json
  profile_json=$(_api "${API_V1}/me/profile")
  loyalty_json=$(_api "${API_V1}/me/loyalty")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    python3 -c "
import json, sys
profile = json.loads(sys.argv[1])
loyalty = json.loads(sys.argv[2])
print(json.dumps({'profile': profile.get('data'), 'loyalty': loyalty.get('data', [])}, indent=2))
" "$profile_json" "$loyalty_json"
    return
  fi

  python3 -c "
import json, sys
profile_payload = json.loads(sys.argv[1])
loyalty_payload = json.loads(sys.argv[2])
profile = profile_payload.get('data') or {}
programs = loyalty_payload.get('data') or []

def mask_number(raw):
    if not raw:
        return 'N/A'
    if len(raw) <= 4:
        return '*' * len(raw)
    return raw[:2] + '*' * (len(raw) - 5) + raw[-3:]

print('=== Traveler Profile ===')
print(f\"Seat:     {profile.get('seat_preference') or 'no_preference'}\")
print(f\"Meal:     {profile.get('meal_preference') or 'no_preference'}\")
print(f\"Alliance: {profile.get('airline_alliance') or 'none'}\")
print(f\"Hotel:    {profile.get('hotel_brand_preference') or '-'}\")
print(f\"Airport:  {profile.get('home_airport') or '-'}\")
print(f\"Currency: {profile.get('currency_preference') or 'USD'}\")
notes = profile.get('notes')
if notes:
    print(f\"Notes:    {notes}\")
print()
print(f\"=== Loyalty Vault ({len(programs)} programs) ===\")
if not programs:
    print('No loyalty programs saved.')
    sys.exit(0)

for i, p in enumerate(programs, start=1):
    number = p.get('program_number_masked') or mask_number(p.get('program_number', ''))
    tier = p.get('status_tier')
    tier_str = f' [{tier}]' if tier else ''
    print(f\"{i}. {p.get('provider_name', '?')} — {p.get('traveler_name', '?')} — {number}{tier_str}\")
" "$profile_json" "$loyalty_json"
}

cmd_profile_set() {
  local field="${1:?Usage: ubt profile set <field> <value>}"
  shift
  local value="${*}"
  if [ -z "$value" ]; then
    echo "Usage: ubt profile set <field> <value>" >&2
    exit 1
  fi

  local api_field=""
  case "$field" in
    seat) api_field="seat_preference" ;;
    meal) api_field="meal_preference" ;;
    alliance) api_field="airline_alliance" ;;
    hotel) api_field="hotel_brand_preference" ;;
    airport) api_field="home_airport" ;;
    currency) api_field="currency_preference" ;;
    notes) api_field="notes" ;;
    *)
      echo "Invalid field: $field" >&2
      echo "Valid fields: seat, meal, alliance, hotel, airport, currency, notes" >&2
      exit 1
      ;;
  esac

  local body
  body=$(python3 -c "import json,sys; print(json.dumps({sys.argv[1]: sys.argv[2]}))" "$api_field" "$value")
  local result
  result=$(_api -X PUT "${API_V1}/me/profile" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
data = json.load(sys.stdin)
if 'error' in data:
    print(f\"Error: {data['error']['message']}\")
    sys.exit(1)
print('Updated traveler profile.')
"
}

cmd_profile_loyalty_list() {
  local result
  result=$(_api "${API_V1}/me/loyalty")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
programs = payload.get('data', [])
print(f'=== Loyalty Vault ({len(programs)} programs) ===')
if not programs:
    print('No loyalty programs saved.')
    sys.exit(0)
for i, p in enumerate(programs, start=1):
    number = p.get('program_number_masked') or 'N/A'
    tier = p.get('status_tier')
    tier_str = f' [{tier}]' if tier else ''
    print(f\"{i}. {p.get('provider_name', '?')} — {p.get('traveler_name', '?')} — {number}{tier_str}\")
"
}

cmd_profile_loyalty_add() {
  local traveler_name provider_type provider_name provider_key program_number status_tier
  read -r -p "Traveler name: " traveler_name
  read -r -p "Provider type (airline/hotel/car_rental/other): " provider_type
  read -r -p "Provider name: " provider_name
  read -r -p "Provider key (normalized, e.g. united): " provider_key
  read -r -p "Program number: " program_number
  read -r -p "Status tier (optional): " status_tier

  local body
  body=$(python3 -c "
import json, sys
traveler_name, provider_type, provider_name, provider_key, program_number, status_tier = sys.argv[1:]
payload = {
    'traveler_name': traveler_name,
    'provider_type': provider_type,
    'provider_name': provider_name,
    'provider_key': provider_key,
    'program_number': program_number,
}
if status_tier.strip():
    payload['status_tier'] = status_tier.strip()
print(json.dumps(payload))
" "$traveler_name" "$provider_type" "$provider_name" "$provider_key" "$program_number" "$status_tier")

  local result
  result=$(_api -X POST "${API_V1}/me/loyalty" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
d = payload.get('data', {})
print(f\"Added loyalty program: {d.get('provider_name', '?')} ({d.get('id', '')[:8]}...)\")
"
}

cmd_profile_loyalty_edit() {
  local program_id="${1:?Usage: ubt profile loyalty edit <id>}"
  local list_result current
  list_result=$(_api "${API_V1}/me/loyalty")
  current=$(python3 -c "
import json, sys
payload = json.loads(sys.argv[1])
target = sys.argv[2]
programs = payload.get('data', [])
for p in programs:
    if p.get('id') == target:
        print(json.dumps(p))
        break
" "$list_result" "$program_id")

  if [ -z "$current" ]; then
    echo "Loyalty program not found: $program_id" >&2
    exit 1
  fi

  python3 -c "
import json, sys
p = json.loads(sys.argv[1])
print('Current values:')
print(f\"  traveler_name: {p.get('traveler_name', '')}\")
print(f\"  provider_name: {p.get('provider_name', '')}\")
print(f\"  program_number: {p.get('program_number_masked', 'N/A')}\")
print(f\"  status_tier: {p.get('status_tier') or ''}\")
print(f\"  preferred: {p.get('preferred')}\")
print(f\"  notes: {p.get('notes') or ''}\")
" "$current"

  local traveler_name provider_name program_number status_tier preferred notes
  read -r -p "Traveler name (blank=keep): " traveler_name
  read -r -p "Provider name (blank=keep): " provider_name
  read -r -p "Program number (blank=keep): " program_number
  read -r -p "Status tier (blank=keep, '-' to clear): " status_tier
  read -r -p "Preferred (blank=keep, true/false): " preferred
  read -r -p "Notes (blank=keep, '-' to clear): " notes

  local body
  body=$(python3 -c "
import json, sys
traveler_name, provider_name, program_number, status_tier, preferred, notes = sys.argv[1:]
payload = {}
if traveler_name.strip():
    payload['traveler_name'] = traveler_name.strip()
if provider_name.strip():
    payload['provider_name'] = provider_name.strip()
if program_number.strip():
    payload['program_number'] = program_number.strip()
if status_tier.strip():
    payload['status_tier'] = None if status_tier.strip() == '-' else status_tier.strip()
if preferred.strip():
    raw = preferred.strip().lower()
    if raw in {'true','t','yes','y','1'}:
        payload['preferred'] = True
    elif raw in {'false','f','no','n','0'}:
        payload['preferred'] = False
if notes.strip():
    payload['notes'] = None if notes.strip() == '-' else notes.strip()
print(json.dumps(payload))
" "$traveler_name" "$provider_name" "$program_number" "$status_tier" "$preferred" "$notes")

  if [ "$body" = "{}" ]; then
    echo "No changes provided."
    return
  fi

  local result
  result=$(_api -X PATCH "${API_V1}/me/loyalty/${program_id}" -d "$body")
  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi
  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
print('Updated loyalty program.')
"
}

cmd_profile_loyalty_delete() {
  local program_id="${1:?Usage: ubt profile loyalty delete <id>}"
  local confirm
  read -r -p "Delete loyalty program ${program_id}? [y/N]: " confirm
  case "${confirm}" in
    y|Y|yes|YES) ;;
    *) echo "Canceled."; return ;;
  esac

  local status
  status=$(curl -s -o /dev/null -w "%{http_code}" \
    -X DELETE "${API_V1}/me/loyalty/${program_id}" \
    -H "Authorization: Bearer ${UBT_API_KEY}" \
    -H "Content-Type: application/json")

  if [ "$status" = "204" ]; then
    echo "Deleted."
  else
    echo "Failed (HTTP ${status})"
    exit 1
  fi
}

cmd_profile_loyalty_lookup() {
  local provider_key="${1:?Usage: ubt profile loyalty lookup <provider_key>}"
  local result
  result=$(_api "${API_V1}/me/loyalty/lookup?provider=${provider_key}")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
if payload.get('exact_match') and payload.get('program'):
    p = payload['program']
    print('Exact match found:')
    print(f\"  Provider: {p.get('provider_name')}\")
    print(f\"  Traveler: {p.get('traveler_name')}\")
    print(f\"  Number:   {p.get('program_number_masked') or p.get('program_number')}\")
    if p.get('status_tier'):
        print(f\"  Tier:     {p.get('status_tier')}\")
    sys.exit(0)
cp = payload.get('compatible_program')
if cp:
    print('Alliance-compatible program found:')
    print(f\"  Alliance: {payload.get('alliance')}\")
    print(f\"  Provider: {cp.get('provider_name')}\")
    print(f\"  Traveler: {cp.get('traveler_name')}\")
    print(f\"  Number:   {cp.get('program_number_masked') or cp.get('program_number')}\")
    if cp.get('status_tier'):
        print(f\"  Tier:     {cp.get('status_tier')}\")
    sys.exit(0)
print('No loyalty match found.')
"
}

cmd_profile_loyalty_export() {
  _api "${API_V1}/me/loyalty/export"
}

cmd_family_list() {
  local result
  result=$(_api "${API_V1}/families")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
families = payload.get('data', [])
if not families:
    print('No families found.')
    sys.exit(0)
print(f'Families ({len(families)}):')
for f in families:
    print(f\"  {f.get('id','')[:8]}  {f.get('name','(unnamed)'):<32} role:{f.get('role','?'):<6} members:{f.get('member_count', 0)}\")
"
}

cmd_family_create() {
  local name="$*"
  if [ -z "$name" ]; then
    echo "Usage: ubt family create <family_name>" >&2
    exit 1
  fi

  local body
  body=$(python3 -c "import json,sys; print(json.dumps({'name': sys.argv[1]}))" "$name")

  local result
  result=$(_api -X POST "${API_V1}/families" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
family = payload.get('data', {})
print('Family created:')
print(f\"  id:   {family.get('id')}\")
print(f\"  name: {family.get('name')}\")
"
}

cmd_family_show() {
  local family_id="${1:?Usage: ubt family show <family_id>}"
  local result
  result=$(_api "${API_V1}/families/${family_id}")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
family = payload.get('data', {})
print('Family:')
print(f\"  id:          {family.get('id')}\")
print(f\"  name:        {family.get('name')}\")
print(f\"  viewer_role: {family.get('viewer_role')}\")
print(f\"  created_at:  {family.get('created_at')}\")
members = family.get('members', [])
print()
print(f'Members ({len(members)}):')
if not members:
    sys.exit(0)
for member in members:
    role = member.get('role', '?')
    status = 'pending' if member.get('pending') else 'accepted'
    name = member.get('name') or member.get('email') or member.get('invited_email') or '-'
    email = member.get('email') or member.get('invited_email') or '-'
    user_id = member.get('user_id') or '-'
    print(f\"  {member.get('id','')[:8]}  {name:<28} {email:<32} role:{role:<6} {status}\")
    print(f\"           user_id: {user_id}\")
"
}

cmd_family_invite() {
  local family_id="${1:?Usage: ubt family invite <family_id> <email>}"
  local email="${2:?Usage: ubt family invite <family_id> <email>}"
  local body
  body=$(python3 -c "import json,sys; print(json.dumps({'email': sys.argv[1]}))" "$email")

  local result
  result=$(_api -X POST "${API_V1}/families/${family_id}/members" -d "$body")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
member = payload.get('data', {})
print('Invite created:')
print(f\"  member_id: {member.get('id')}\")
print(f\"  email:     {member.get('invited_email')}\")
print(f\"  role:      {member.get('role')}\")
print('Invite email queued.')
"
}

cmd_family_remove() {
  local family_id="${1:?Usage: ubt family remove <family_id> <user_id>}"
  local user_or_member_id="${2:?Usage: ubt family remove <family_id> <user_id>}"

  local family_result
  family_result=$(_api "${API_V1}/families/${family_id}")

  local member_id
  member_id=$(python3 -c "
import json, sys
payload = json.load(sys.stdin)
target = sys.argv[1]
if 'error' in payload:
    print('__ERROR__:' + payload['error'].get('message', 'Failed to load family.'))
    sys.exit(0)
family = payload.get('data', {})
members = family.get('members', [])
for m in members:
    if m.get('id') == target or m.get('user_id') == target:
        print(m.get('id', ''))
        sys.exit(0)
print('')
" "$user_or_member_id" <<<"$family_result")

  if [[ "$member_id" == __ERROR__:* ]]; then
    echo "Error: ${member_id#__ERROR__:}" >&2
    exit 1
  fi

  if [ -z "$member_id" ]; then
    echo "Error: Could not find member for '${user_or_member_id}' in this family." >&2
    exit 1
  fi

  local status
  status=$(curl -s -o /dev/null -w "%{http_code}" \
    -X DELETE "${API_V1}/families/${family_id}/members/${member_id}" \
    -H "Authorization: Bearer ${UBT_API_KEY}" \
    -H "Content-Type: application/json")

  if [ "$status" = "204" ] || [ "$status" = "200" ]; then
    echo "Removed member ${member_id:0:8} from family ${family_id:0:8}."
  else
    echo "Failed (HTTP ${status})"
    exit 1
  fi
}

cmd_family_leave() {
  local family_id="${1:?Usage: ubt family leave <family_id>}"
  local profile_json family_json
  profile_json=$(_api "${API_V1}/me/profile")
  family_json=$(_api "${API_V1}/families/${family_id}")

  local member_id
  member_id=$(python3 -c "
import json, sys
profile = json.loads(sys.argv[1])
family = json.loads(sys.argv[2])
if 'error' in profile:
    print('__ERROR__:' + profile['error'].get('message', 'Failed to load profile.'))
    sys.exit(0)
if 'error' in family:
    print('__ERROR__:' + family['error'].get('message', 'Failed to load family.'))
    sys.exit(0)
viewer_id = (profile.get('data') or {}).get('id')
for m in (family.get('data') or {}).get('members', []):
    if m.get('user_id') == viewer_id:
        print(m.get('id', ''))
        sys.exit(0)
print('')
" "$profile_json" "$family_json")

  if [[ "$member_id" == __ERROR__:* ]]; then
    echo "Error: ${member_id#__ERROR__:}" >&2
    exit 1
  fi

  if [ -z "$member_id" ]; then
    echo "Error: You do not have an accepted membership in this family." >&2
    exit 1
  fi

  local status
  status=$(curl -s -o /dev/null -w "%{http_code}" \
    -X DELETE "${API_V1}/families/${family_id}/members/${member_id}" \
    -H "Authorization: Bearer ${UBT_API_KEY}" \
    -H "Content-Type: application/json")

  if [ "$status" = "204" ] || [ "$status" = "200" ]; then
    echo "Left family ${family_id:0:8}."
  else
    echo "Failed (HTTP ${status})"
    exit 1
  fi
}

cmd_family_loyalty() {
  local family_id="${1:?Usage: ubt family loyalty <family_id>}"
  local result
  result=$(_api "${API_V1}/families/${family_id}/loyalty")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
rows = payload.get('data', [])
meta = payload.get('meta', {})
print(f\"Family loyalty programs ({len(rows)}), members: {meta.get('family_member_count', '?')}\")
if not rows:
    sys.exit(0)
for p in rows:
    number = p.get('program_number_masked') or p.get('program_number') or 'N/A'
    member = p.get('member_name') or p.get('traveler_name') or p.get('user_id', '')[:8]
    preferred = ' *preferred' if p.get('preferred') else ''
    print(f\"  {p.get('provider_name','?'):<26} {member:<24} {number}{preferred}\")
"
}

cmd_family_loyalty_lookup() {
  local family_id="${1:?Usage: ubt family loyalty lookup <family_id> <provider>}"
  local provider="${2:?Usage: ubt family loyalty lookup <family_id> <provider>}"
  local encoded_provider
  encoded_provider=$(python3 -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))" "$provider")
  local result
  result=$(_api "${API_V1}/families/${family_id}/loyalty/lookup?provider=${encoded_provider}")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
rows = payload.get('data', [])
meta = payload.get('meta', {})
provider_key = meta.get('provider_key', '?')
alliance = meta.get('alliance')
print(f\"Lookup: {provider_key}\")
if alliance:
    print(f\"Alliance fallback: {alliance}\")
print(f\"Matched members: {meta.get('matched_count', 0)} / {meta.get('family_member_count', len(rows))}\")
print()
for row in rows:
    member = row.get('member_name') or row.get('user_id', '')[:8]
    program = row.get('program')
    if not program:
        print(f\"  {member:<24} no match\")
        continue
    match_type = 'exact' if row.get('exact_match') else 'alliance'
    number = program.get('program_number_masked') or program.get('program_number') or 'N/A'
    print(f\"  {member:<24} {program.get('provider_name','?'):<28} {number} ({match_type})\")
"
}

cmd_family_profiles() {
  local family_id="${1:?Usage: ubt family profiles <family_id>}"
  local result
  result=$(_api "${API_V1}/families/${family_id}/profiles")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
profiles = payload.get('data', [])
print(f'Family profiles ({len(profiles)}):')
if not profiles:
    sys.exit(0)
for p in profiles:
    name = p.get('full_name') or p.get('email') or p.get('user_id', '')[:8]
    seat = p.get('seat_preference') or 'no_preference'
    meal = p.get('meal_preference') or 'no_preference'
    home = p.get('home_airport') or '-'
    print(f\"  {name:<30} seat:{seat:<14} meal:{meal:<14} home:{home}\")
"
}

cmd_family_trips() {
  local family_id="${1:?Usage: ubt family trips <family_id>}"
  local scope="${2:-all}"
  local result
  result=$(_api "${API_V1}/families/${family_id}/trips?scope=${scope}")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
trips = payload.get('data', [])
meta = payload.get('meta', {})
print(f\"Family trips ({len(trips)}), scope: {meta.get('scope', 'all')}\")
if not trips:
    sys.exit(0)
for t in trips:
    owner = ((t.get('owner') or {}).get('full_name')) or t.get('owner_name') or (t.get('user_id','')[:8])
    dates = t.get('start_date') or '-'
    if t.get('end_date') and t.get('end_date') != t.get('start_date'):
        dates += ' → ' + t.get('end_date')
    print(f\"  {t.get('id','')[:8]}  {t.get('title','(unnamed)'):<28} {dates:<24} owner:{owner}\")
"
}

cmd_family_guides() {
  local family_id="${1:?Usage: ubt family guides <family_id>}"
  local result
  result=$(_api "${API_V1}/families/${family_id}/guides")

  if [ "${FORMAT:-pretty}" = "json" ]; then
    echo "$result" | _json
    return
  fi

  echo "$result" | python3 -c "
import json, sys
payload = json.load(sys.stdin)
if 'error' in payload:
    print(f\"Error: {payload['error']['message']}\")
    sys.exit(1)
guides = payload.get('data', [])
print(f'Family guides ({len(guides)}):')
if not guides:
    sys.exit(0)
for g in guides:
    owner = ((g.get('owner') or {}).get('full_name')) or g.get('owner_name') or (g.get('user_id','')[:8])
    city = g.get('city', '?')
    country = g.get('country') or g.get('country_code') or ''
    entries = g.get('entry_count')
    if entries is None:
        entries = len(g.get('entries') or [])
    place = city if not country else f\"{city}, {country}\"
    print(f\"  {g.get('id','')[:8]}  {place:<30} entries:{entries:<4} owner:{owner}\")
"
}

cmd_version() {
  echo "$UBT_VERSION"
}

cmd_login() {
  echo -n "Enter your UBT API key (from ubtrippin.xyz/settings): "
  read -r key
  if [ -z "$key" ]; then
    echo "No key entered." >&2
    exit 1
  fi
  local result
  result=$(curl -s -w "\n%{http_code}" "${API_V1}/me/profile" \
    -H "Authorization: Bearer ${key}" \
    -H "Content-Type: application/json")
  local http_code body
  http_code=$(echo "$result" | tail -1)
  body=$(echo "$result" | sed \$d)
  if [ "$http_code" != "200" ]; then
    echo "Invalid API key (HTTP ${http_code})." >&2
    exit 1
  fi
  local name
  name=$(echo "$body" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('data',{}).get('full_name','') or d.get('data',{}).get('email','user'))" 2>/dev/null || echo "user")
  mkdir -p "$HOME/.ubt"
  echo "UBT_API_KEY=${key}" > "$HOME/.ubt/config"
  echo "Logged in as ${name}. Config saved to ~/.ubt/config"
}

cmd_selftest() {
  if [ -z "$UBT_API_KEY" ]; then
    echo "FAIL: No API key configured. Run 'ubt login' or set UBT_API_KEY." >&2
    exit 1
  fi
  local endpoints="trips me/profile me/loyalty guides settings/senders"
  local all_pass=true
  for ep in $endpoints; do
    local status
    status=$(curl -s -o /dev/null -w "%{http_code}" "${API_V1}/${ep}" \
      -H "Authorization: Bearer ${UBT_API_KEY}" \
      -H "Content-Type: application/json")
    if [ "$status" = "200" ]; then
      echo "  PASS  GET /api/v1/${ep} (${status})"
    else
      echo "  FAIL  GET /api/v1/${ep} (${status})"
      all_pass=false
    fi
  done
  if [ "$all_pass" = true ]; then
    echo "All checks passed."
    exit 0
  else
    echo "Some checks failed." >&2
    exit 1
  fi
}

# Usage
usage() {
  cat <<EOF
ubt — UB Trippin CLI

Usage: ubt <command> [args]

  version                               Print CLI version
  login                                 Authenticate with your API key
  selftest                              Test API connectivity

Commands:
  trips list [user_id]                  List all trips (owned + shared)
  trips show <trip_id>                  Show trip details + items
  trips create <title> [--start Y-M-D] [--end Y-M-D]  Create a trip *
  trips update <trip_id> [--title X] [--notes X] [--start X] [--end X]  Update a trip *
  trips rename <trip_id> <new_title>    Rename a trip *
  trips delete <trip_id>                Delete a trip *
  trips status <trip_id>                Show live statuses for trip flight/train items *
  trips merge <target> <source>         Merge source trip into target (deletes source) *
  items list <trip_id>                  List items in a trip
  items show <item_id>                  Show item details *
  items add <trip_id> --kind <k> --summary <text> [--provider X] [--start-ts X] [--end-ts X] [--start-location X] [--end-location X] [--details-json '{...}']  Add item *
  items update <item_id> [--summary X] [--start-location X] [--end-location X] [--status X]  Update item *
  items delete <item_id>                Delete an item *
  items status <item_id>                Show item live status *
  items refresh <item_id>               Refresh item live status *
  items move <item_id> <trip_id>        Move item to another trip *
  guides list                           List city guides *
  guides create <city> [--country X] [--country-code XX]  Create guide *
  guides show <guide_id>                Show guide + entries *
  guides delete <guide_id>              Delete guide *
  guides entry add <guide_id> --name <name> --category <cat> [--description X] [--url X] [--tags tag1,tag2] [--status visited|to_try]  Add guide entry *
  guides entry update <guide_id> <entry_id> [--name X] [--category X] [--description X]  Update guide entry *
  guides entry delete <guide_id> <entry_id>  Delete guide entry *
  guides nearby --lat X --lng Y         Find nearby guide entries *
  trains status <train_number>          Show train status (uses today's UTC date unless --date) *
  billing show                          Show current billing subscription details *
  billing portal                        Get Stripe billing portal URL *
  activation status                     Show activation/onboarding status *
  calendar get                          Get your iCal feed URL *
  calendar regen                        Regenerate calendar token (invalidates old URL) *
  image search <query>                  Search Unsplash for cover images *
  senders list                          List allowed email senders *
  senders add <email> [label]           Add an allowed sender *
  senders remove <id>                   Remove an allowed sender *
  webhooks list                         List registered webhooks *
  webhooks add <url> [--events a,b] [--secret s] [--description text]  Add webhook *
  webhooks show <id>                    Show webhook details *
  webhooks delete <id>                  Delete a webhook *
  webhooks test <id>                    Send test ping *
  webhooks deliveries <id>              List delivery logs *
  collab list <trip_id>                 List collaborators on a trip you own *
  collab invite <trip_id> <email> [role] Invite a collaborator (editor or viewer) *
  collab remove <trip_id> <collab_id>   Remove a collaborator *
  family list                           List families *
  family create <name>                  Create a family (Pro) *
  family show <family_id>               Show family details + members *
  family invite <family_id> <email>     Invite a family member (Pro) *
  family remove <family_id> <user_id>   Remove family member by user_id/member_id *
  family leave <family_id>              Leave a family *
  family loyalty <family_id>            List family loyalty programs *
  family loyalty lookup <family_id> <provider> Lookup provider across family members *
  family profiles <family_id>           List family profiles *
  family trips <family_id> [scope]      List family trips (scope: all/current/upcoming/past) *
  family guides <family_id>             List family guides *
  notifications list [--unread]         List notifications *
  notifications read <id>               Mark a notification as read *
  profile show                          Show traveler profile + loyalty vault *
  profile set <field> <value>           Update one traveler profile field *
  profile loyalty list                  List loyalty programs (masked) *
  profile loyalty add                   Add a loyalty program (interactive) *
  profile loyalty edit <id>             Edit a loyalty program (interactive) *
  profile loyalty delete <id>           Delete a loyalty program *
  profile loyalty lookup <provider_key> Lookup by provider (alliance fallback aware) *
  profile loyalty export                Export loyalty vault JSON *
  users                                 List all users (admin)
  health                                Check service health
  rls-check                             Verify RLS policies

Commands marked * require UBT_API_KEY in ~/.ubt/config or env.

Options:
  FORMAT=json ubt ...      Output raw JSON instead of formatted text
  UBT_API_URL=...          Override API base URL (default: https://www.ubtrippin.xyz/api/v1)

Examples:
  ubt trips list
  ubt trips show 58bd2048-607c-4afc-a915-2edb6a9f6c54
  ubt trips create "Paris Weekend" --start 2026-04-10 --end 2026-04-14
  ubt trips update <trip_id> --notes "Bring passports"
  ubt trips rename <trip_id> "NYC + Boston"
  ubt trips status <trip_id>
  ubt trips merge <target_id> <source_id>
  ubt items show <item_id>
  ubt items add <trip_id> --kind flight --summary "UA 101 SFO to JFK" --start-ts 2026-04-10T08:30:00Z
  ubt items update <item_id> --status confirmed
  ubt items status <item_id>
  ubt items refresh <item_id>
  ubt items move <item_id> <target_trip_id>
  ubt guides list
  ubt guides create "Tokyo" --country Japan --country-code JP
  ubt guides entry add <guide_id> --name "Sushi Dai" --category Food --status to_try
  ubt guides nearby --lat 35.6762 --lng 139.6503
  ubt trains status TGV1234 --date 2026-06-01
  ubt billing show
  ubt activation status
  ubt calendar get
  ubt senders list
  ubt webhooks list
  ubt webhooks add https://example.com/webhooks/ubt --events item.created,item.updated
  ubt image search "paris eiffel tower"
  FORMAT=json ubt items list <trip_id>
  ubt collab list <trip_id>
  ubt collab invite <trip_id> friend@example.com editor
  ubt collab remove <trip_id> <collab_id>
  ubt family list
  ubt family create "Rogers Family"
  ubt family show <family_id>
  ubt family invite <family_id> parent@example.com
  ubt family loyalty lookup <family_id> united
  ubt notifications list --unread
  ubt notifications read <notification_id>
  ubt profile show
  ubt profile set seat window
  ubt profile loyalty lookup united
EOF
}

# Main router
case "${1:-}" in
  trips)
    case "${2:-}" in
      list)  cmd_trips_list "${3:-}" ;;
      show)  cmd_trips_show "${3:?Usage: ubt trips show <trip_id>}" ;;
      create) shift 2; cmd_trips_create "$@" ;;
      update) shift 2; cmd_trips_update "$@" ;;
      rename) cmd_trips_rename "${3:-}" "${@:4}" ;;
      delete) cmd_trips_delete "${3:-}" ;;
      status) cmd_trips_status "${3:-}" ;;
      merge) cmd_trips_merge "${3:-}" "${4:-}" ;;
      *)     usage ;;
    esac
    ;;
  items)
    case "${2:-}" in
      list) cmd_items_list "${3:?Usage: ubt items list <trip_id>}" ;;
      show) cmd_items_show "${3:-}" ;;
      add) shift 2; cmd_items_add "$@" ;;
      update) shift 2; cmd_items_update "$@" ;;
      delete) cmd_items_delete "${3:-}" ;;
      status) cmd_items_status "${3:-}" ;;
      refresh) cmd_items_refresh "${3:-}" ;;
      move) cmd_items_move "${3:-}" "${4:-}" ;;
      *)    usage ;;
    esac
    ;;
  guides)
    case "${2:-}" in
      list) cmd_guides_list ;;
      create) shift 2; cmd_guides_create "$@" ;;
      show) cmd_guides_show "${3:-}" ;;
      delete) cmd_guides_delete "${3:-}" ;;
      nearby) shift 2; cmd_guides_nearby "$@" ;;
      entry)
        case "${3:-}" in
          add) shift 3; cmd_guides_entry_add "$@" ;;
          update) shift 3; cmd_guides_entry_update "$@" ;;
          delete) shift 3; cmd_guides_entry_delete "$@" ;;
          *) usage ;;
        esac
        ;;
      *) usage ;;
    esac
    ;;
  trains)
    case "${2:-}" in
      status) shift 2; cmd_trains_status "$@" ;;
      *)      usage ;;
    esac
    ;;
  billing)
    case "${2:-}" in
      show)   cmd_billing_show ;;
      portal) cmd_billing_portal ;;
      *)      usage ;;
    esac
    ;;
  activation)
    case "${2:-}" in
      status) cmd_activation_status ;;
      *)      usage ;;
    esac
    ;;
  calendar)
    case "${2:-}" in
      get)   cmd_calendar_get ;;
      regen) cmd_calendar_regen ;;
      *)     usage ;;
    esac
    ;;
  senders)
    case "${2:-}" in
      list)   cmd_senders_list ;;
      add)    cmd_senders_add "${3:-}" "${4:-}" ;;
      remove) cmd_senders_remove "${3:?Usage: ubt senders remove <sender_id>}" ;;
      *)      usage ;;
    esac
    ;;
  webhooks)
    case "${2:-}" in
      list)       cmd_webhooks_list ;;
      add)        shift 2; cmd_webhooks_add "$@" ;;
      show)       cmd_webhooks_show "${3:-}" ;;
      delete)     cmd_webhooks_delete "${3:-}" ;;
      test)       cmd_webhooks_test "${3:-}" ;;
      deliveries) cmd_webhooks_deliveries "${3:-}" ;;
      *)          usage ;;
    esac
    ;;
  image)
    case "${2:-}" in
      search) cmd_image_search "${3:?Usage: ubt image search <query>}" ;;
      *)      usage ;;
    esac
    ;;
  collab)
    case "${2:-}" in
      list)   cmd_collab_list "${3:?Usage: ubt collab list <trip_id>}" ;;
      invite) cmd_collab_invite "${3:-}" "${4:-}" "${5:-}" ;;
      remove) cmd_collab_remove "${3:-}" "${4:-}" ;;
      *)      usage ;;
    esac
    ;;
  family)
    case "${2:-}" in
      list)    cmd_family_list ;;
      create)  shift 2; cmd_family_create "$@" ;;
      show)    cmd_family_show "${3:?Usage: ubt family show <family_id>}" ;;
      invite)  cmd_family_invite "${3:-}" "${4:-}" ;;
      remove)  cmd_family_remove "${3:-}" "${4:-}" ;;
      leave)   cmd_family_leave "${3:-}" ;;
      loyalty)
        if [ "${3:-}" = "lookup" ]; then
          cmd_family_loyalty_lookup "${4:-}" "${5:-}"
        elif [ -n "${3:-}" ] && [ "${3:-}" != "list" ]; then
          cmd_family_loyalty "${3:-}"
        else
          cmd_family_loyalty "${4:-}"
        fi
        ;;
      profiles) cmd_family_profiles "${3:-}" ;;
      trips)    cmd_family_trips "${3:-}" "${4:-}" ;;
      guides)   cmd_family_guides "${3:-}" ;;
      *)        usage ;;
    esac
    ;;
  notifications)
    case "${2:-}" in
      list) cmd_notifications_list "${3:-}" ;;
      read) cmd_notifications_read "${3:?Usage: ubt notifications read <notification_id>}" ;;
      *)    usage ;;
    esac
    ;;
  profile)
    case "${2:-}" in
      show) cmd_profile_show ;;
      set) cmd_profile_set "${@:3}" ;;
      loyalty)
        case "${3:-}" in
          list)   cmd_profile_loyalty_list ;;
          add)    cmd_profile_loyalty_add ;;
          edit)   cmd_profile_loyalty_edit "${4:-}" ;;
          delete) cmd_profile_loyalty_delete "${4:-}" ;;
          lookup) cmd_profile_loyalty_lookup "${4:-}" ;;
          export) cmd_profile_loyalty_export ;;
          *)      usage ;;
        esac
        ;;
      *) usage ;;
    esac
    ;;
  users)    cmd_users ;;
  health)   cmd_health ;;
  rls-check) cmd_rls_check ;;
  version)  cmd_version ;;
  login)    cmd_login ;;
  selftest) cmd_selftest ;;
  -h|--help|help|"") usage ;;
  *) echo "Unknown command: $1"; usage; exit 1 ;;
esac
